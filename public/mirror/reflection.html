<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <title>Your Reflection | Mirror of Truth</title>

    <style>
      /* Mirror â€“ Luminous Reflection Experience - Mobile Optimized */
      /* Beautiful question appearance animation */
      @keyframes questionGlow {
        0% {
          opacity: 0;
          transform: translateY(30px) scale(0.98);
          box-shadow: 0 0 0 rgba(255, 255, 255, 0);
        }
        50% {
          box-shadow: 0 0 40px rgba(255, 255, 255, 0.08),
            inset 0 0 20px rgba(255, 255, 255, 0.02);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          box-shadow: 0 0 0 rgba(255, 255, 255, 0);
        }
      }

      .question-group.appear {
        animation: questionGlow 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }

      /* â•­â”€ COSMIC FOUNDATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #020617;
        color: #fff;
        overflow-x: hidden;
        font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;
        scroll-behavior: smooth;
        min-height: 100vh;
        position: relative;

        /* Mobile optimizations */
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
        touch-action: manipulation;
      }

      /* Subtle animated background gradient */
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: radial-gradient(
            circle at 20% 30%,
            rgba(59, 130, 246, 0.05) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(147, 51, 234, 0.04) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 50% 50%,
            rgba(251, 191, 36, 0.03) 0%,
            transparent 70%
          );
        z-index: 0;
        animation: cosmicShift 60s ease-in-out infinite;
      }

      @keyframes cosmicShift {
        0%,
        100% {
          transform: scale(1) rotate(0deg);
        }
        33% {
          transform: scale(1.1) rotate(120deg);
        }
        66% {
          transform: scale(0.9) rotate(240deg);
        }
      }

      /* â•­â”€ TONE-SPECIFIC BACKGROUNDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      /* Fusion: Golden-amber breathing circles */
      body.tone-fusion::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: 1;
        pointer-events: none;
        opacity: 0.8;
      }

      .fusion-breath {
        position: fixed;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(251, 191, 36, 0.25) 0%,
          rgba(245, 158, 11, 0.12) 30%,
          rgba(217, 119, 6, 0.06) 60%,
          transparent 80%
        );
        filter: blur(30px);
        animation: fusionBreathe 20s ease-in-out infinite;
        z-index: 1;
        pointer-events: none;
      }

      @keyframes fusionBreathe {
        0% {
          opacity: 0;
          transform: scale(0.5) translate(0, 0);
        }
        25% {
          opacity: 0.5;
          transform: scale(1) translate(20px, -30px);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.3) translate(-10px, 20px);
        }
        75% {
          opacity: 0.4;
          transform: scale(0.9) translate(30px, 10px);
        }
        100% {
          opacity: 0;
          transform: scale(0.4) translate(0, 0);
        }
      }

      /* Gentle: Twinkling stars */
      .gentle-star {
        position: fixed;
        width: 3px;
        height: 3px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 50%;
        box-shadow: 0 0 6px rgba(255, 255, 255, 0.6),
          0 0 12px rgba(255, 255, 255, 0.3);
        animation: gentleTwinkle 8s ease-in-out infinite;
        z-index: 1;
        pointer-events: none;
      }

      @keyframes gentleTwinkle {
        0%,
        100% {
          opacity: 0;
          transform: scale(0.5);
        }
        50% {
          opacity: 1;
          transform: scale(1.2);
        }
      }

      /* Intense: Purple fire swirls */
      .intense-swirl {
        position: fixed;
        width: clamp(150px, 30vw, 200px);
        height: clamp(150px, 30vw, 200px);
        background: radial-gradient(
          circle at 30% 30%,
          rgba(147, 51, 234, 0.3) 0%,
          rgba(168, 85, 247, 0.15) 30%,
          rgba(139, 92, 246, 0.08) 60%,
          transparent 80%
        );
        filter: blur(25px);
        border-radius: 50%;
        animation: intenseSwirl 15s ease-in-out infinite;
        z-index: 1;
        pointer-events: none;
      }

      @keyframes intenseSwirl {
        0% {
          opacity: 0;
          transform: rotate(0deg) scale(0.3);
        }
        25% {
          opacity: 0.6;
          transform: rotate(180deg) scale(1);
        }
        50% {
          opacity: 0.8;
          transform: rotate(360deg) scale(1.3);
        }
        75% {
          opacity: 0.5;
          transform: rotate(540deg) scale(0.8);
        }
        100% {
          opacity: 0;
          transform: rotate(720deg) scale(0.2);
        }
      }

      /* â•­â”€ SUBTLE STARFIELD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      body::after {
        content: "";
        position: fixed;
        inset: 0;
        z-index: 1;
        pointer-events: none;
        background: radial-gradient(
            circle at 20% 30%,
            rgba(255, 255, 255, 0.3) 0 1px,
            transparent 2px
          ),
          radial-gradient(
            circle at 60% 70%,
            rgba(255, 255, 255, 0.25) 0 1px,
            transparent 2px
          ),
          radial-gradient(
            circle at 80% 20%,
            rgba(255, 255, 255, 0.28) 0 1px,
            transparent 2px
          ),
          radial-gradient(
            circle at 40% 90%,
            rgba(255, 255, 255, 0.22) 0 1px,
            transparent 2px
          );
        background-size: 1000px 800px, 1400px 1000px, 800px 1100px, 1200px 900px;
        opacity: 0.08;
        animation: starfieldShimmer 120s linear infinite;
      }

      @keyframes starfieldShimmer {
        0% {
          transform: translate(0, 0);
        }
        100% {
          transform: translate(-50px, -50px);
        }
      }

      /* â•­â”€ CONTENT CONTAINER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 1rem;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 10;
      }

      /* â•­â”€ EXPERIENCE SECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      .experience-section {
        width: 100%;
        text-align: center;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .experience-section.active {
        opacity: 1;
        transform: translateY(0);
      }

      .experience-section.hidden {
        display: none;
      }

      /* â•­â”€ TONE SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      .tone-group {
        display: flex;
        gap: 0.8rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        justify-content: center;
      }

      .tone-label {
        flex-basis: 100%;
        margin-bottom: 1rem;
        font-size: clamp(1rem, 3vw, 1.1rem);
        opacity: 0.8;
        color: rgba(255, 255, 255, 0.85);
        letter-spacing: 0.5px;
        text-align: center;
        font-weight: 300;
      }

      .tone-btn {
        flex: 1;
        min-width: 120px;
        max-width: 200px;
        padding: 1rem 1.2rem;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        font-weight: 400;
        letter-spacing: 0.3px;
        font-size: clamp(0.85rem, 2.5vw, 0.95rem);

        /* Mobile optimizations */
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .tone-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.9);
        transform: translateY(-2px);
      }

      .tone-btn:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }

      .tone-btn.selected {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
        color: #fff;
      }

      /* Subtle tone-specific accents */
      .tone-btn[data-tone="fusion"].selected {
        border-color: rgba(251, 191, 36, 0.3);
        background: rgba(251, 191, 36, 0.05);
      }

      .tone-btn[data-tone="gentle"].selected {
        border-color: rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.08);
      }

      .tone-btn[data-tone="intense"].selected {
        border-color: rgba(147, 51, 234, 0.3);
        background: rgba(147, 51, 234, 0.05);
      }

      /* â•­â”€ QUESTIONS FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      .questions-form {
        text-align: left;
      }

      .question-group {
        margin-bottom: 2.5rem;
        padding: 2rem 1.5rem;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.03) 0%,
          rgba(255, 255, 255, 0.01) 100%
        );
        backdrop-filter: blur(40px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        position: relative;
        overflow: hidden;
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .question-group::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at 20% 50%,
          rgba(255, 255, 255, 0.02) 0%,
          transparent 50%
        );
        opacity: 0;
        transition: opacity 0.6s ease;
      }

      .question-group:hover::before {
        opacity: 1;
      }

      .question-group:hover {
        border-color: rgba(255, 255, 255, 0.12);
        transform: translateY(-2px);
        box-shadow: 0 10px 40px rgba(255, 255, 255, 0.03);
      }

      .question-number {
        font-size: clamp(0.7rem, 2vw, 0.8rem);
        opacity: 0.4;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: rgba(255, 255, 255, 0.4);
        font-weight: 500;
      }

      .question-text {
        font-size: clamp(1.2rem, 4vw, 1.5rem);
        margin-bottom: 0.8rem;
        line-height: 1.4;
        color: rgba(255, 255, 255, 0.95);
        font-weight: 300;
        letter-spacing: 0.5px;
        text-shadow: 0 2px 10px rgba(255, 255, 255, 0.05);
      }

      .question-subtitle {
        font-size: clamp(0.85rem, 2.5vw, 0.95rem);
        opacity: 0.55;
        margin-bottom: 1.5rem;
        font-style: italic;
        color: rgba(255, 255, 255, 0.55);
        line-height: 1.5;
        font-weight: 300;
        letter-spacing: 0.3px;
      }

      /* â•­â”€ INPUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      .sacred-input {
        width: 100%;
        padding: 1.2rem;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.04) 0%,
          rgba(255, 255, 255, 0.02) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        color: #fff;
        font-size: clamp(0.9rem, 2.5vw, 1rem);
        font-family: inherit;
        transition: all 0.3s ease;
        resize: vertical;
        position: relative;

        /* Mobile optimizations */
        -webkit-appearance: none;
        appearance: none;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        box-sizing: border-box;

        /* Prevent zoom on iOS */
        transform-origin: left top;
        zoom: 1;

        /* Ensure minimum height for touch targets */
        min-height: 44px;
      }

      .sacred-input:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.25);
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.06) 0%,
          rgba(255, 255, 255, 0.03) 100%
        );
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.05),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
      }

      .sacred-input::placeholder {
        color: rgba(255, 255, 255, 0.35);
        font-style: italic;
      }

      .question-textarea {
        min-height: 120px;
        line-height: 1.6;
        resize: vertical;
      }

      /* â•­â”€ YES/NO BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      .yes-no-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
      }

      .yes-no-btn {
        flex: 1;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.04);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 400;
        letter-spacing: 0.5px;
        font-size: clamp(0.9rem, 2.5vw, 1rem);

        /* Mobile optimizations */
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .yes-no-btn:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.9);
      }

      .yes-no-btn:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }

      .yes-no-btn.selected {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.25);
        color: #fff;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.08);
      }

      /* â•­â”€ DATE CONTAINER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      .date-container {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1.5rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        animation: fadeIn 0.6s ease;
        flex-wrap: wrap;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .date-container label {
        color: rgba(255, 255, 255, 0.8);
        font-weight: 400;
        font-size: clamp(0.85rem, 2.5vw, 0.95rem);
        min-width: fit-content;
      }

      /* â•­â”€ SUBMIT BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      .submit-btn {
        width: 100%;
        margin-top: 2rem;
        padding: 1.2rem 2rem;
        font-size: clamp(1rem, 3vw, 1.1rem);
        font-weight: 400;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 20px;
        color: #fff;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        letter-spacing: 0.5px;

        /* Mobile optimizations */
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 52px;
      }

      .submit-btn:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.25);
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(255, 255, 255, 0.08);
      }

      .submit-btn:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }

      .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* â•­â”€ LOADING STATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2rem;
        padding: 2rem;
      }

      .loading-circle {
        width: clamp(120px, 30vw, 150px);
        height: clamp(120px, 30vw, 150px);
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.12) 0%,
          rgba(255, 255, 255, 0.04) 40%,
          rgba(255, 255, 255, 0.01) 70%,
          transparent 85%
        );
        animation: breatheLoading 4s ease-in-out infinite;
        position: relative;
        box-shadow: 0 0 40px rgba(255, 255, 255, 0.06),
          inset 0 0 20px rgba(255, 255, 255, 0.03);
      }

      .loading-circle::after {
        content: "";
        position: absolute;
        inset: 20px;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.08) 0%,
          rgba(255, 255, 255, 0.02) 50%,
          transparent 75%
        );
        animation: breatheInner 4s ease-in-out infinite;
      }

      @keyframes breatheLoading {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.7;
        }
        50% {
          transform: scale(1.1);
          opacity: 1;
        }
      }

      @keyframes breatheInner {
        0%,
        100% {
          transform: scale(1) rotate(0deg);
          opacity: 0.5;
        }
        50% {
          transform: scale(1.2) rotate(180deg);
          opacity: 0.8;
        }
      }

      .loading-text {
        font-size: clamp(1rem, 3vw, 1.2rem);
        font-weight: 300;
        opacity: 0.7;
        text-align: center;
        letter-spacing: 0.8px;
        color: rgba(255, 255, 255, 0.8);
      }

      /* â•­â”€ RESULTS SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      .results {
        text-align: left;
        max-width: 700px;
        margin: 0 auto;
        padding: 0 1rem;
      }

      .results-backdrop {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.03) 0%,
          rgba(255, 255, 255, 0.01) 100%
        );
        backdrop-filter: blur(40px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 24px;
        padding: 2rem 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        position: relative;
      }

      .results-content {
        background: rgba(255, 255, 255, 0.95);
        color: #1a1a2e;
        padding: 2rem 1.5rem;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        font-size: clamp(1rem, 2.5vw, 1.1rem);
        line-height: 1.7;
        font-weight: 300;
      }

      .results-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 2rem;
      }

      .results-actions .sacred-button {
        background: rgba(255, 255, 255, 0.06);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 1rem 1.5rem;
        border-radius: 16px;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 400;
        letter-spacing: 0.3px;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: clamp(0.85rem, 2.5vw, 0.95rem);

        /* Mobile optimizations */
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 44px;
        min-width: 120px;
        flex: 1;
        max-width: 200px;
      }

      .results-actions .sacred-button:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
      }

      .results-actions .sacred-button:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }

      /* â•­â”€ ADMIN NOTICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      .admin-notice {
        background: rgba(168, 85, 247, 0.08);
        border: 1px solid rgba(168, 85, 247, 0.2);
        color: #d8b4fe;
        padding: 0.8rem 1.2rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        font-size: clamp(0.8rem, 2vw, 0.85rem);
        font-weight: 400;
        letter-spacing: 0.3px;
        text-align: center;
      }

      /* â•­â”€ FEEDBACK SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      .feedback-section {
        margin: 3rem 0;
        padding: 2.5rem;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        transition: all 0.8s ease;
      }

      .feedback-content {
        text-align: center;
        max-width: 600px;
        margin: 0 auto;
      }

      .feedback-title {
        font-size: clamp(1.2rem, 3vw, 1.4rem);
        font-weight: 300;
        color: rgba(255, 255, 255, 0.95);
        margin-bottom: 2rem;
        line-height: 1.4;
      }

      .rating-container {
        display: flex;
        justify-content: center;
        gap: 0.8rem;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
      }

      .rating-btn {
        width: 48px;
        height: 48px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .rating-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.4);
        transform: translateY(-2px);
      }

      .rating-btn.selected {
        background: linear-gradient(135deg, #10b981, #059669);
        border-color: #10b981;
        color: white;
        font-weight: 600;
        transform: scale(1.1);
      }

      .rating-labels {
        display: flex;
        justify-content: space-between;
        max-width: 500px;
        margin: 0 auto 2rem;
        font-size: 0.9rem;
        opacity: 0.6;
      }

      .feedback-insight {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        padding: 1rem;
        margin-bottom: 2rem;
        resize: vertical;
        min-height: 80px;
        font-family: inherit;
        font-size: 1rem;
        line-height: 1.6;
        transition: all 0.3s ease;
      }

      .feedback-insight:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.08);
      }

      .feedback-insight::placeholder {
        color: rgba(255, 255, 255, 0.4);
      }

      .submit-feedback-btn,
      .skip-feedback-btn {
        padding: 1rem 2rem;
        border-radius: 16px;
        border: none;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .submit-feedback-btn {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        margin-right: 1rem;
      }

      .submit-feedback-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
      }

      .submit-feedback-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }

      .skip-feedback-btn {
        background: transparent;
        color: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .skip-feedback-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.8);
        border-color: rgba(255, 255, 255, 0.3);
      }

      /* Premium badge */
      .premium-badge {
        position: absolute;
        top: -1px;
        right: 1.5rem;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 0.4rem 1rem;
        border-radius: 0 0 16px 16px;
        font-size: 0.8rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        z-index: 20;
      }

      /* Creator button special styling */
      .creator-button {
        background: linear-gradient(
          135deg,
          rgba(147, 51, 234, 0.15),
          rgba(59, 130, 246, 0.1)
        ) !important;
        border-color: rgba(147, 51, 234, 0.3) !important;
        position: relative;
        overflow: hidden;
      }

      .creator-button::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          135deg,
          rgba(147, 51, 234, 0.1),
          rgba(59, 130, 246, 0.05)
        );
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .creator-button:hover::before {
        opacity: 1;
      }

      .creator-button:hover {
        border-color: rgba(147, 51, 234, 0.5) !important;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(147, 51, 234, 0.2) !important;
      }

      /* Admin notice animation */
      #adminNotice {
        animation: gentleGlow 3s ease-in-out infinite;
      }

      @keyframes gentleGlow {
        0%,
        100% {
          background: rgba(168, 85, 247, 0.08);
          border-color: rgba(168, 85, 247, 0.2);
        }
        50% {
          background: rgba(168, 85, 247, 0.12);
          border-color: rgba(168, 85, 247, 0.3);
        }
      }

      /* Subtle effects animations */
      @keyframes subtleExpand {
        0% {
          opacity: 0;
          transform: scale(0.5);
        }
        50% {
          opacity: 0.4;
        }
        100% {
          opacity: 0;
          transform: scale(2.5);
        }
      }

      @keyframes subtleTwinkle {
        0% {
          opacity: 0;
          transform: scale(0) rotate(0deg);
        }
        50% {
          opacity: 1;
          transform: scale(1.2) rotate(180deg);
        }
        100% {
          opacity: 0;
          transform: scale(0) rotate(360deg);
        }
      }

      @keyframes subtleSwirl {
        0% {
          opacity: 0;
          transform: scale(0.5) rotate(0deg);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.2) rotate(180deg);
        }
        100% {
          opacity: 0;
          transform: scale(1.8) rotate(360deg);
        }
      }

      /* â•­â”€ MOBILE RESPONSIVE DESIGN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® */
      @media (max-width: 768px) {
        .container {
          padding: 0.5rem;
        }

        .question-group {
          padding: 1.5rem 1rem;
          margin-bottom: 2rem;
        }

        .tone-group {
          flex-direction: column;
          gap: 0.8rem;
          margin-bottom: 1.5rem;
        }

        .tone-btn {
          min-width: auto;
          max-width: none;
        }

        .yes-no-buttons {
          flex-direction: column;
          gap: 0.8rem;
        }

        .date-container {
          flex-direction: column;
          align-items: stretch;
          gap: 0.8rem;
        }

        .results-backdrop {
          padding: 1.5rem 1rem;
        }

        .results-content {
          padding: 1.5rem 1rem;
        }

        .results-actions {
          flex-direction: column;
          gap: 0.8rem;
        }

        .results-actions .sacred-button {
          flex: none;
          max-width: none;
        }

        .feedback-section {
          padding: 1.5rem;
          margin: 2rem 0;
        }

        .rating-container {
          gap: 0.5rem;
        }

        .rating-btn {
          width: 40px;
          height: 40px;
          font-size: 1rem;
        }

        .feedback-title {
          font-size: 1.2rem;
          margin-bottom: 1.5rem;
        }

        .submit-feedback-btn,
        .skip-feedback-btn {
          display: block;
          width: 100%;
          margin: 0.5rem 0;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 0.25rem;
        }

        .question-group {
          padding: 1.2rem 0.8rem;
          margin-bottom: 1.5rem;
          border-radius: 16px;
        }

        .sacred-input {
          padding: 1rem;
        }

        .question-textarea {
          min-height: 100px;
        }

        .submit-btn {
          padding: 1rem 1.5rem;
          margin-top: 1.5rem;
        }

        .results-backdrop {
          padding: 1.2rem 0.8rem;
          border-radius: 20px;
        }

        .results-content {
          padding: 1.2rem 0.8rem;
          border-radius: 16px;
        }

        .loading-container {
          padding: 1rem;
          gap: 1.5rem;
        }
      }

      /* Landscape mobile optimization */
      @media (max-height: 600px) and (orientation: landscape) {
        .container {
          align-items: flex-start;
          padding-top: 1rem;
        }

        .question-group {
          margin-bottom: 1.5rem;
          padding: 1.2rem 1rem;
        }

        .tone-group {
          margin-bottom: 1rem;
        }

        .submit-btn {
          margin-top: 1.5rem;
        }
      }

      /* High DPI displays */
      @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .question-group,
        .sacred-input,
        .tone-btn,
        .yes-no-btn,
        .submit-btn {
          border-width: 0.5px;
        }
      }

      /* Reduce motion for accessibility */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }

        .fusion-breath,
        .gentle-star,
        .intense-swirl,
        .loading-circle {
          animation: none;
        }
      }
    </style>
  </head>

  <body>
    <!-- Tone-specific background animations added via JS -->

    <div class="container">
      <!-- Questions Section -->
      <div class="experience-section active" id="questions">
        <form id="reflectionForm" class="questions-form">
          <!-- Tone Picker -->
          <div class="tone-group">
            <div class="tone-label">Choose the voice of your reflection</div>

            <div class="tone-btn selected" data-tone="fusion">
              Let the Mirror Breathe
            </div>
            <div class="tone-btn" data-tone="gentle">Gentle Clarity</div>
            <div class="tone-btn" data-tone="intense">Luminous Fire</div>
          </div>

          <div class="question-group">
            <div class="question-number">Question 1</div>
            <div class="question-text">What is your dream?</div>
            <div class="question-subtitle">
              Choose just one â€” the one that calls you most right now.
            </div>
            <textarea
              id="dreamInput"
              name="dream"
              class="question-textarea sacred-input"
              placeholder="Write the dream that calls you..."
              required
            ></textarea>
          </div>

          <div class="question-group">
            <div class="question-number">Question 2</div>
            <div class="question-text">
              What is your plan for achieving this dream?
            </div>
            <div class="question-subtitle">
              Write what you already know. It's okay if it's unclear.
            </div>
            <textarea
              id="planInput"
              name="plan"
              class="question-textarea sacred-input"
              placeholder="Describe any plan (or absence of plan)..."
              required
            ></textarea>
          </div>

          <div class="question-group">
            <div class="question-number">Question 3</div>
            <div class="question-text">
              Have you set a definite date for fulfilling your dream?
            </div>
            <div class="yes-no-buttons">
              <div class="yes-no-btn" id="yesBtn" data-value="yes">Yes</div>
              <div class="yes-no-btn" id="noBtn" data-value="no">No</div>
            </div>
            <input type="hidden" name="hasDate" required />
            <div
              class="date-container"
              id="dateContainer"
              style="display: none"
            >
              <label>What is the date?</label>
              <input type="date" class="sacred-input" name="dreamDate" />
            </div>
          </div>

          <div class="question-group">
            <div class="question-number">Question 4</div>
            <div class="question-text">
              What is your current relationship with this dream?
            </div>
            <div class="question-subtitle">
              Do you believe you'll achieve it? Why or why not?
            </div>
            <textarea
              id="relationshipInput"
              name="relationship"
              class="question-textarea sacred-input"
              placeholder="How do you relate to this dream now?"
              required
            ></textarea>
          </div>

          <div class="question-group">
            <div class="question-number">Question 5</div>
            <div class="question-text">
              What are you willing to give in return?
            </div>
            <div class="question-subtitle">
              Energy, focus, love, time â€” what will you offer to this dream?
            </div>
            <textarea
              id="offeringInput"
              name="offering"
              class="question-textarea sacred-input"
              placeholder="What will you offer in return?"
              required
            ></textarea>
          </div>

          <button type="submit" class="submit-btn" id="submitBtn">
            Receive Your Reflection
          </button>
        </form>
      </div>

      <!-- Loading Section -->
      <div class="experience-section hidden" id="loading">
        <div class="loading-container">
          <div class="loading-circle"></div>
          <div class="loading-text">Reflecting your truth...</div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="experience-section hidden" id="results">
        <div class="results">
          <div class="admin-notice" id="adminNotice" style="display: none">
            <span>âœ¨ Admin session â€” unlimited reflections</span>
          </div>
          <div class="results-backdrop">
            <div class="results-content" id="reflectionContent"></div>
          </div>
          <div class="results-actions">
            <button
              class="sacred-button"
              id="emailBtn"
              onclick="emailReflection()"
            >
              <span>ðŸ“§</span><span>Mail me this reflection</span>
            </button>
            <a href="/behind-the-mirror" class="sacred-button creator-button">
              <span>ðŸ¤²</span><span>Who created this?</span>
            </a>
            <a href="/" class="sacred-button">
              <span>ðŸªž</span><span>Return to Portal</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Mirror â€“ Luminous Reflection Logic with Authentication + Feedback
      let userData = null;
      let hasDateSet = null;
      let isCreatorMode = false;
      let isTestMode = false;
      let isPremiumMode = false;
      let selectedTone = "fusion";
      let backgroundElements = [];
      let formState = {};
      let currentReflection = null;
      let currentReflectionId = null;
      let authToken = null;

      /* â€” INITIALIZATION â€” */
      window.addEventListener("load", () => {
        checkAuthAndSetup();
        initializeToneBackground();
        setupInteractions();
        animateQuestions();
        handleURLState();
      });

      /* â€” AUTHENTICATION & USER SETUP â€” */
      async function checkAuthAndSetup() {
        const url = new URLSearchParams(location.search);
        const mode = url.get("mode");
        const premium = url.get("premium");

        authToken = localStorage.getItem("mirror_auth_token");

        if (mode === "creator") {
          isCreatorMode = true;
          isPremiumMode = true;

          if (authToken) {
            try {
              const user = await verifyAuthToken();
              if (user && user.isCreator) {
                userData = user;
                showAdminNotice(
                  "âœ¨ Creator mode â€” unlimited premium reflections"
                );
                return;
              }
            } catch (error) {
              console.error("Creator auth verification failed:", error);
            }
          }

          userData = {
            isCreator: true,
            name: "Ahiya",
            email: "ahiya.butman@gmail.com",
            tier: "premium",
          };
          showAdminNotice("âœ¨ Creator mode â€” premium reflection as Ahiya");
        } else if (mode === "user") {
          isTestMode = true;
          isPremiumMode = premium === "true";

          const tempUser = localStorage.getItem("mirrorTempUser");
          if (tempUser) {
            userData = JSON.parse(tempUser);
            userData.testMode = true;
          } else {
            userData = {
              name: "Test User",
              email: "test@example.com",
              tier: isPremiumMode ? "premium" : "essential",
              testMode: true,
            };
          }
          showAdminNotice(
            `ðŸŒŸ Test mode â€” ${
              isPremiumMode ? "premium" : "essential"
            } reflection as another soul`
          );
        } else {
          if (!authToken) {
            redirectToAuth("Authentication required for reflections");
            return;
          }

          try {
            userData = await verifyAuthToken();
            if (!userData) {
              redirectToAuth("Please sign in to continue");
              return;
            }

            const canReflect = await checkUsageLimits();
            if (!canReflect) {
              return;
            }

            isPremiumMode = userData.tier === "premium" || userData.isCreator;
            console.log(
              `âœ… Authenticated reflection: ${userData.email} (${userData.tier})`
            );
          } catch (error) {
            console.error("Authentication error:", error);
            redirectToAuth("Authentication failed, please sign in again");
            return;
          }
        }
      }

      async function verifyAuthToken() {
        try {
          const response = await fetch("/api/auth", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ action: "verify-token" }),
          });

          const result = await response.json();
          if (result.success && result.user) {
            return result.user;
          }

          throw new Error("Token verification failed");
        } catch (error) {
          localStorage.removeItem("mirror_auth_token");
          localStorage.removeItem("mirrorUserData");
          throw error;
        }
      }

      async function checkUsageLimits() {
        if (isCreatorMode || isTestMode) return true;

        try {
          const response = await fetch("/api/users?action=get-usage", {
            headers: { Authorization: `Bearer ${authToken}` },
          });

          const result = await response.json();
          if (!result.success) {
            throw new Error("Failed to check usage limits");
          }

          const usage = result.usage;
          if (!usage.current.canReflect) {
            showUsageLimitReached(usage.current);
            return false;
          }

          return true;
        } catch (error) {
          console.error("Usage check error:", error);
          return true;
        }
      }

      function redirectToAuth(message) {
        alert(message);
        const returnUrl = encodeURIComponent(
          window.location.pathname + window.location.search
        );
        window.location.href = `/auth/signin?returnTo=${returnUrl}`;
      }

      function showUsageLimitReached(usage) {
        const limitReachedHtml = `
          <div class="limit-reached-container">
            <div class="limit-reached-card">
              <div class="limit-icon">ðŸŒ™</div>
              <h2>Reflection Limit Reached</h2>
              <p>You've used <strong>${usage.count} of ${usage.limit}</strong> reflections this month.</p>
              <p>Your journey continues beyond limits.</p>
              <div class="limit-actions">
                <a href="/dashboard?tab=upgrade" class="upgrade-btn">
                  <span>ðŸš€</span><span>Upgrade for More</span>
                </a>
                <a href="/dashboard" class="dashboard-btn">
                  <span>ðŸ“š</span><span>View My Reflections</span>
                </a>
              </div>
            </div>
          </div>
        `;

        document.body.innerHTML = limitReachedHtml;

        const style = document.createElement("style");
        style.textContent = `
          .limit-reached-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #0f0f23 100%);
          }
          .limit-reached-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 3rem 2rem;
            text-align: center;
            color: white;
            max-width: 400px;
            width: 100%;
          }
          .limit-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
          }
          .limit-reached-card h2 {
            font-size: 1.8rem;
            font-weight: 300;
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.95);
          }
          .limit-reached-card p {
            margin-bottom: 1rem;
            opacity: 0.8;
            line-height: 1.6;
          }
          .limit-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
          }
          .upgrade-btn, .dashboard-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            padding: 1rem 1.5rem;
            border-radius: 16px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
          }
          .upgrade-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
          }
          .dashboard-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
          }
          .upgrade-btn:hover, .dashboard-btn:hover {
            transform: translateY(-2px);
          }
        `;
        document.head.appendChild(style);
      }

      function showAdminNotice(message) {
        const notice = document.getElementById("adminNotice");
        if (notice) {
          notice.style.display = "block";
          notice.innerHTML = `<span>${message}</span>`;
        }
      }

      /* â€” URL STATE MANAGEMENT â€” */
      function handleURLState() {
        const urlParams = new URLSearchParams(window.location.search);

        if (urlParams.get("state") === "reflection" && urlParams.get("id")) {
          const reflectionId = urlParams.get("id");
          const storedReflection = localStorage.getItem(
            `reflection_${reflectionId}`
          );

          if (storedReflection) {
            try {
              const reflectionData = JSON.parse(storedReflection);
              document.getElementById("reflectionContent").innerHTML =
                reflectionData.content;
              if (reflectionData.isPremium) {
                showPremiumBadge();
              }
              showSection("results");
              return;
            } catch (e) {
              console.error("Failed to restore reflection:", e);
            }
          }
        }

        if (urlParams.get("state") === "form") {
          const savedForm = localStorage.getItem("mirror_form_state");
          if (savedForm) {
            try {
              formState = JSON.parse(savedForm);
              restoreFormState();
            } catch (e) {
              console.error("Failed to restore form state:", e);
            }
          }
        }
      }

      function saveFormState() {
        const form = document.getElementById("reflectionForm");
        const formData = new FormData(form);

        formState = {
          dream: formData.get("dream") || "",
          plan: formData.get("plan") || "",
          hasDate: formData.get("hasDate") || "",
          dreamDate: formData.get("dreamDate") || "",
          relationship: formData.get("relationship") || "",
          offering: formData.get("offering") || "",
          tone: selectedTone,
          timestamp: Date.now(),
        };

        localStorage.setItem("mirror_form_state", JSON.stringify(formState));

        const url = new URL(window.location);
        url.searchParams.set("state", "form");
        window.history.replaceState({}, "", url);
      }

      function restoreFormState() {
        if (!formState || Object.keys(formState).length === 0) return;

        const form = document.getElementById("reflectionForm");
        Object.entries(formState).forEach(([key, value]) => {
          if (key === "tone") {
            selectedTone = value;
            selectTone(value);
            return;
          }

          const field = form.querySelector(`[name="${key}"]`);
          if (field) {
            field.value = value;

            if (key === "hasDate" && value) {
              hasDateSet = value;

              document.querySelectorAll(".yes-no-btn").forEach((btn) => {
                btn.classList.remove("selected");
                if (btn.dataset.value === value) {
                  btn.classList.add("selected");
                }
              });

              const dateContainer = document.getElementById("dateContainer");
              const dateInput = dateContainer.querySelector("input");
              if (value === "yes") {
                dateContainer.style.display = "flex";
                dateInput.required = true;
              }
            }
          }
        });
      }

      /* â€” TONE BACKGROUND SYSTEM â€” */
      function initializeToneBackground() {
        document.body.classList.add(`tone-${selectedTone}`);
        createToneElements(selectedTone);
      }

      function createToneElements(tone) {
        backgroundElements.forEach((el) => el.remove());
        backgroundElements = [];

        if (tone === "fusion") {
          for (let i = 0; i < 5; i++) {
            const breath = document.createElement("div");
            breath.className = "fusion-breath";
            breath.style.width = `${180 + Math.random() * 120}px`;
            breath.style.height = breath.style.width;
            breath.style.left = `${Math.random() * 100}%`;
            breath.style.top = `${Math.random() * 100}%`;
            breath.style.animationDelay = `${i * 4}s`;
            breath.style.animationDuration = `${15 + Math.random() * 8}s`;
            document.body.appendChild(breath);
            backgroundElements.push(breath);
          }
        } else if (tone === "gentle") {
          for (let i = 0; i < 30; i++) {
            const star = document.createElement("div");
            star.className = "gentle-star";
            star.style.left = `${Math.random() * 100}%`;
            star.style.top = `${Math.random() * 100}%`;
            star.style.animationDelay = `${Math.random() * 8}s`;
            star.style.animationDuration = `${5 + Math.random() * 5}s`;
            document.body.appendChild(star);
            backgroundElements.push(star);
          }
        } else if (tone === "intense") {
          for (let i = 0; i < 6; i++) {
            const swirl = document.createElement("div");
            swirl.className = "intense-swirl";
            swirl.style.left = `${Math.random() * 100}%`;
            swirl.style.top = `${Math.random() * 100}%`;
            swirl.style.animationDelay = `${i * 3}s`;
            swirl.style.animationDuration = `${10 + Math.random() * 8}s`;
            document.body.appendChild(swirl);
            backgroundElements.push(swirl);
          }
        }
      }

      /* â€” QUESTION ANIMATION â€” */
      function animateQuestions() {
        const questions = document.querySelectorAll(".question-group");
        questions.forEach((q, i) => {
          q.style.opacity = "0";
          setTimeout(() => {
            q.classList.add("appear");
          }, 400 + i * 200);
        });
      }

      /* â€” INTERACTIONS â€” */
      function setupInteractions() {
        /* Tone Picker */
        document.querySelectorAll(".tone-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            selectTone(this.dataset.tone || "fusion");
          });
        });

        /* Yes/No Interactions */
        document.querySelectorAll(".yes-no-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            this.parentNode
              .querySelectorAll(".yes-no-btn")
              .forEach((b) => b.classList.remove("selected"));
            this.classList.add("selected");

            hasDateSet = this.dataset.value;
            document.querySelector('input[name="hasDate"]').value = hasDateSet;

            const box = document.getElementById("dateContainer");
            const dateInp = box.querySelector("input");
            if (hasDateSet === "yes") {
              box.style.display = "flex";
              dateInp.required = true;
            } else {
              box.style.display = "none";
              dateInp.required = false;
              dateInp.value = "";
            }

            saveFormState();
          });
        });

        /* Save form state on input changes */
        document.querySelectorAll(".sacred-input").forEach((input) => {
          input.addEventListener("input", debounce(saveFormState, 1000));
        });

        /* Subtle animations when typing */
        document.querySelectorAll(".sacred-input").forEach((input) => {
          input.addEventListener("focus", function () {
            if (selectedTone === "fusion") {
              createSubtleBreath(this);
            } else if (selectedTone === "gentle") {
              createSubtleTwinkle(this);
            } else if (selectedTone === "intense") {
              createSubtleSwirl(this);
            }
          });
        });

        /* Form Submission */
        document
          .getElementById("reflectionForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!authToken && !isCreatorMode && !isTestMode) {
              redirectToAuth("Please sign in to save your reflection");
              return;
            }

            showSection("loading");

            const fd = new FormData(e.target);

            const payload = {
              dream: fd.get("dream"),
              plan: fd.get("plan"),
              hasDate: fd.get("hasDate"),
              dreamDate: fd.get("dreamDate"),
              relationship: fd.get("relationship"),
              offering: fd.get("offering"),
              userName: userData?.name || "Friend",
              userEmail: userData?.email || "",
              language: "en",
              isAdmin: isCreatorMode || isTestMode,
              isCreator: isCreatorMode,
              isPremium: isPremiumMode,
              tone: selectedTone,
            };

            try {
              const headers = { "Content-Type": "application/json" };
              if (authToken) {
                headers["Authorization"] = `Bearer ${authToken}`;
              }

              const res = await fetch("/api/reflection", {
                method: "POST",
                headers: headers,
                body: JSON.stringify(payload),
              });

              const data = await res.json();

              if (!data.success) {
                if (data.requiresAuth) {
                  redirectToAuth("Authentication required");
                  return;
                } else if (data.needsUpgrade) {
                  showUsageLimitReached(data);
                  return;
                }
                throw new Error(data.error || "Reflection failed");
              }

              document.getElementById("reflectionContent").innerHTML =
                data.reflection;

              currentReflectionId = data.reflectionId;

              if (data.isPremium) {
                showPremiumBadge();
              }

              saveReflectionWithId(
                data.reflectionId,
                data.reflection,
                data.isPremium
              );

              if (
                data.shouldTriggerEvolution &&
                !isCreatorMode &&
                !isTestMode
              ) {
                showEvolutionPrompt();
              }

              showSection("results");

              if (!isCreatorMode && !isTestMode && currentReflectionId) {
                setTimeout(showFeedbackSection, 3000);
              }
            } catch (err) {
              console.error(err);
              document.getElementById("reflectionContent").innerHTML = `
                <h2>A moment of silenceâ€¦</h2>
                <p>Your reflection is being prepared. Please try again soon.</p>`;
              showSection("results");
            }
          });
      }

      /* â€” FEEDBACK COLLECTION â€” */
      function showFeedbackSection() {
        if (document.getElementById("feedbackSection")) return;

        const feedbackHtml = `
          <div class="feedback-section" id="feedbackSection">
            <div class="feedback-content">
              <h3 class="feedback-title">How deeply did this help you access your truth?</h3>
              <div class="rating-container">
                ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
                  .map(
                    (n) =>
                      `<button class="rating-btn" data-rating="${n}">${n}</button>`
                  )
                  .join("")}
              </div>
              <div class="rating-labels">
                <span>Not at all</span>
                <span>Deeply</span>
              </div>
              <textarea 
                class="feedback-insight sacred-input" 
                id="feedbackInsight"
                placeholder="What emerged for you? (optional)"
                maxlength="500"
                rows="3"
              ></textarea>
              <button class="submit-feedback-btn" id="submitFeedbackBtn">Submit & Continue</button>
              <button class="skip-feedback-btn" id="skipFeedbackBtn">Skip</button>
            </div>
          </div>
        `;

        const actionsSection = document.querySelector(".results-actions");
        actionsSection.insertAdjacentHTML("beforebegin", feedbackHtml);

        const feedbackSection = document.getElementById("feedbackSection");
        feedbackSection.style.opacity = "0";
        feedbackSection.style.transform = "translateY(20px)";

        setTimeout(() => {
          feedbackSection.style.transition = "all 0.8s ease";
          feedbackSection.style.opacity = "1";
          feedbackSection.style.transform = "translateY(0)";
        }, 100);

        setupFeedbackInteractions();
      }

      function setupFeedbackInteractions() {
        let selectedRating = null;

        document.querySelectorAll(".rating-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            document
              .querySelectorAll(".rating-btn")
              .forEach((b) => b.classList.remove("selected"));
            this.classList.add("selected");
            selectedRating = parseInt(this.dataset.rating);

            this.style.transform = "scale(1.2)";
            setTimeout(() => {
              this.style.transform = "";
            }, 200);
          });
        });

        document
          .getElementById("submitFeedbackBtn")
          .addEventListener("click", async () => {
            if (!selectedRating) {
              alert("Please select a rating from 1-10");
              return;
            }

            await submitFeedback(selectedRating);
          });

        document
          .getElementById("skipFeedbackBtn")
          .addEventListener("click", () => {
            hideFeedbackSection();
          });
      }

      async function submitFeedback(rating) {
        const feedbackText = document
          .getElementById("feedbackInsight")
          .value.trim();

        try {
          const response = await fetch("/api/reflections", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({
              action: "submit-feedback",
              reflectionId: currentReflectionId,
              rating: rating,
              feedback: feedbackText,
            }),
          });

          const data = await response.json();

          if (data.success) {
            const submitBtn = document.getElementById("submitFeedbackBtn");
            submitBtn.textContent = "âœ“ Thank you!";
            submitBtn.disabled = true;

            setTimeout(hideFeedbackSection, 1500);
          } else {
            console.error("Failed to submit feedback:", data.error);
            hideFeedbackSection();
          }
        } catch (error) {
          console.error("Feedback submission error:", error);
          hideFeedbackSection();
        }
      }

      function hideFeedbackSection() {
        const feedbackSection = document.getElementById("feedbackSection");
        if (feedbackSection) {
          feedbackSection.style.transition = "all 0.5s ease";
          feedbackSection.style.opacity = "0";
          feedbackSection.style.transform = "translateY(-20px)";

          setTimeout(() => {
            feedbackSection.remove();
          }, 500);
        }
      }

      function selectTone(tone) {
        if (tone === selectedTone) return;

        selectedTone = tone;

        document
          .querySelectorAll(".tone-btn")
          .forEach((b) => b.classList.remove("selected"));

        document
          .querySelector(`[data-tone="${tone}"]`)
          .classList.add("selected");

        transitionToTone(tone);
        saveFormState();
      }

      function transitionToTone(newTone) {
        document.body.classList.remove(
          "tone-gentle",
          "tone-intense",
          "tone-fusion"
        );
        document.body.classList.add(`tone-${newTone}`);
        createToneElements(newTone);
      }

      function showSection(id) {
        document.querySelectorAll(".experience-section").forEach((sec) => {
          sec.classList.remove("active");
          setTimeout(() => sec.classList.add("hidden"), 400);
        });

        setTimeout(() => {
          document
            .querySelectorAll(".experience-section")
            .forEach((s) => s.classList.add("hidden"));

          const sec = document.getElementById(id);
          sec.classList.remove("hidden");

          setTimeout(() => {
            sec.classList.add("active");
          }, 100);
        }, 400);
      }

      /* â€” REFLECTION STORAGE â€” */
      function saveReflectionWithId(reflectionId, content, isPremium) {
        const reflectionData = {
          content: content,
          isPremium: isPremium,
          timestamp: Date.now(),
          userData: userData,
          reflectionId: reflectionId,
        };

        localStorage.setItem(
          `reflection_${reflectionId}`,
          JSON.stringify(reflectionData)
        );

        const url = new URL(window.location);
        url.searchParams.set("state", "reflection");
        url.searchParams.set("id", reflectionId);
        window.history.replaceState({}, "", url);

        localStorage.removeItem("mirror_form_state");
      }

      /* â€” EVOLUTION REPORT PROMPT â€” */
      function showEvolutionPrompt() {
        const evolutionPrompt = document.createElement("div");
        evolutionPrompt.className = "evolution-prompt";
        evolutionPrompt.innerHTML = `
          <div class="evolution-prompt-content">
            <div class="evolution-icon">ðŸŒ±</div>
            <h3>Evolution Report Available</h3>
            <p>You've reached a milestone in your reflection journey. Generate your evolution report to see your growth patterns.</p>
            <div class="evolution-actions">
              <button onclick="generateEvolutionReport()" class="evolution-btn">
                Generate Report
              </button>
              <button onclick="closeEvolutionPrompt()" class="evolution-dismiss">
                Later
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(evolutionPrompt);

        const style = document.createElement("style");
        style.textContent = `
          .evolution-prompt {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: rgba(16, 185, 129, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 300px;
            color: white;
            z-index: 1000;
            animation: evolutionSlideIn 0.5s ease;
          }
          @keyframes evolutionSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          .evolution-icon {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 1rem;
          }
          .evolution-prompt h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #10b981;
          }
          .evolution-prompt p {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 1.5rem;
            line-height: 1.4;
          }
          .evolution-actions {
            display: flex;
            gap: 0.8rem;
          }
          .evolution-btn, .evolution-dismiss {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
          }
          .evolution-btn {
            background: #10b981;
            color: white;
          }
          .evolution-dismiss {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
          }
          .evolution-btn:hover, .evolution-dismiss:hover {
            transform: translateY(-1px);
          }
        `;
        document.head.appendChild(style);
      }

      function generateEvolutionReport() {
        closeEvolutionPrompt();
        window.location.href = "/evolution?action=generate";
      }

      function closeEvolutionPrompt() {
        const prompt = document.querySelector(".evolution-prompt");
        if (prompt) {
          prompt.remove();
        }
      }

      /* â€” EMAIL HELPER â€” */
      function emailReflection() {
        if (!isCreatorMode && !isTestMode) {
          alert(
            "Your reflection is automatically saved to your dashboard. Visit your dashboard to access all your reflections."
          );
          return;
        }

        if (!userData?.email) {
          const email = prompt("Enter your email to receive this reflection:");
          if (!email) return;
          userData = { ...userData, email };
        }

        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = "<span>âœ¨</span><span>Sending...</span>";
        btn.disabled = true;

        const emailName = isCreatorMode ? "Ahiya" : userData.name || "Friend";

        fetch("/api/communication", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "send-reflection",
            email: userData.email,
            content: document.getElementById("reflectionContent").innerHTML,
            userName: emailName,
            language: "en",
            isPremium: isPremiumMode,
          }),
        })
          .then((r) => r.json())
          .then((d) => {
            btn.innerHTML = d.success
              ? "<span>âœ…</span><span>Reflection sent</span>"
              : "<span>âš¡</span><span>Try again</span>";

            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.disabled = false;
            }, 2000);
          })
          .catch(() => {
            btn.innerHTML = "<span>ðŸŒ™</span><span>Try again</span>";
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.disabled = false;
            }, 2000);
          });
      }

      /* â€” HELPER FUNCTIONS â€” */
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      function createSubtleBreath(element) {
        const rect = element.getBoundingClientRect();
        const breath = document.createElement("div");
        breath.style.cssText = `
          position: fixed;
          left: ${rect.left + rect.width / 2}px;
          top: ${rect.top + rect.height / 2}px;
          width: 150px;
          height: 150px;
          margin-left: -75px;
          margin-top: -75px;
          border-radius: 50%;
          background: radial-gradient(
            circle,
            rgba(251, 191, 36, 0.15) 0%,
            rgba(245, 158, 11, 0.08) 40%,
            transparent 70%
          );
          pointer-events: none;
          z-index: 5;
          animation: subtleExpand 3s ease-out forwards;
        `;
        document.body.appendChild(breath);
        setTimeout(() => breath.remove(), 3000);
      }

      function createSubtleTwinkle(element) {
        const rect = element.getBoundingClientRect();
        for (let i = 0; i < 5; i++) {
          setTimeout(() => {
            const star = document.createElement("div");
            const offsetX = (Math.random() - 0.5) * 150;
            const offsetY = (Math.random() - 0.5) * 150;
            star.style.cssText = `
              position: fixed;
              left: ${rect.left + rect.width / 2 + offsetX}px;
              top: ${rect.top + rect.height / 2 + offsetY}px;
              width: 3px;
              height: 3px;
              background: rgba(255, 255, 255, 0.9);
              border-radius: 50%;
              box-shadow: 0 0 6px rgba(255, 255, 255, 0.5);
              pointer-events: none;
              z-index: 5;
              animation: subtleTwinkle 2s ease-out forwards;
            `;
            document.body.appendChild(star);
            setTimeout(() => star.remove(), 2000);
          }, i * 150);
        }
      }

      function createSubtleSwirl(element) {
        const rect = element.getBoundingClientRect();
        const swirl = document.createElement("div");
        swirl.style.cssText = `
          position: fixed;
          left: ${rect.left + rect.width / 2}px;
          top: ${rect.top + rect.height / 2}px;
          width: 120px;
          height: 120px;
          margin-left: -60px;
          margin-top: -60px;
          border-radius: 50%;
          background: radial-gradient(
            circle,
            rgba(147, 51, 234, 0.2) 0%,
            rgba(168, 85, 247, 0.1) 40%,
            transparent 70%
          );
          pointer-events: none;
          z-index: 5;
          animation: subtleSwirl 3s ease-out forwards;
        `;
        document.body.appendChild(swirl);
        setTimeout(() => swirl.remove(), 3000);
      }

      function showPremiumBadge() {
        const resultsBackdrop = document.querySelector(".results-backdrop");
        const existingBadge = document.querySelector(".premium-badge");
        if (existingBadge) {
          existingBadge.remove();
        }

        if (resultsBackdrop) {
          const badge = document.createElement("div");
          badge.className = "premium-badge";
          badge.innerHTML = "âœ¨ Premium Reflection";
          resultsBackdrop.insertBefore(badge, resultsBackdrop.firstChild);
        }
      }

      // Add dashboard redirect option after reflection completion
      setTimeout(() => {
        const resultsSection = document.getElementById("results");
        if (resultsSection && !resultsSection.classList.contains("hidden")) {
          const actions = document.querySelector(".results-actions");
          if (actions && !isCreatorMode && !isTestMode && authToken) {
            const dashboardBtn = document.createElement("a");
            dashboardBtn.href = "/dashboard";
            dashboardBtn.className = "sacred-button primary";
            dashboardBtn.innerHTML =
              "<span>ðŸ </span><span>View Dashboard</span>";
            actions.insertBefore(dashboardBtn, actions.firstChild);
          }
        }
      }, 5000);
    </script>
  </body>
</html>
