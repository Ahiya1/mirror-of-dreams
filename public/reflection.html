<!-- FILE: public/reflection.html â€¢ English-only version â€¢ 2025-06-01 -->
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Your Reflection</title>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: linear-gradient(
          135deg,
          #0f0f23 0%,
          #1a1a2e 25%,
          #16213e 50%,
          #0f0f23 100%
        );
        min-height: 100vh;
        color: #fff;
        overflow-x: hidden;
      }

      .container {
        max-width: 700px;
        margin: 0 auto;
        padding: 2rem;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .experience-section {
        width: 100%;
        text-align: center;
        opacity: 0;
        transform: translateY(30px);
        transition: 0.8s ease;
      }

      .experience-section.hidden {
        display: none;
      }

      .experience-section.active {
        opacity: 1;
        transform: translateY(0);
      }

      .continue-btn {
        width: 100%;
        padding: 1.2rem 2rem;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 3rem;
      }

      .continue-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .continue-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .questions-form {
        text-align: left;
      }

      .question-group {
        margin-bottom: 3rem;
        opacity: 0;
        transform: translateY(20px);
        transition: 0.6s ease;
      }

      .question-group.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .question-number {
        font-size: 0.9rem;
        opacity: 0.6;
        margin-bottom: 0.5rem;
      }

      .question-text {
        font-size: 1.2rem;
        font-weight: 400;
        margin-bottom: 1rem;
        line-height: 1.4;
      }

      .question-subtitle {
        font-size: 0.9rem;
        opacity: 0.7;
        margin-bottom: 1rem;
        font-style: italic;
      }

      .question-input,
      .question-textarea {
        width: 100%;
        padding: 1.2rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        color: #fff;
        font-size: 1rem;
        line-height: 1.5;
        transition: 0.3s;
        font-family: inherit;
      }

      .question-textarea {
        min-height: 120px;
        resize: vertical;
      }

      .question-input:focus,
      .question-textarea:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.4);
        background: rgba(255, 255, 255, 0.12);
      }

      .question-input::placeholder,
      .question-textarea::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .yes-no-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
      }

      .yes-no-btn {
        flex: 1;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        color: #fff;
        cursor: pointer;
        transition: 0.3s;
        text-align: center;
      }

      .yes-no-btn:hover,
      .yes-no-btn.selected {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
      }

      .date-container {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
      }

      .loading-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.2) 0%,
          rgba(255, 255, 255, 0.05) 70%
        );
        margin: 0 auto 2rem;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.7;
        }
        50% {
          transform: scale(1.05);
          opacity: 1;
        }
      }

      .loading-text {
        font-size: 1.1rem;
        font-weight: 300;
        opacity: 0.8;
        text-align: center;
      }

      .results {
        text-align: left;
      }

      .results-content {
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        padding: 3rem;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        margin-bottom: 2rem;
        line-height: 1.8;
        font-size: 1.05rem;
      }

      .results-content strong {
        color: #16213e;
        font-weight: 600;
      }

      .results-content em {
        color: #666;
        font-style: italic;
      }

      .results-content p {
        margin-bottom: 1.5rem;
      }

      .results-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
      }

      .action-btn {
        padding: 1rem 2rem;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        color: #fff;
        text-decoration: none;
        cursor: pointer;
        transition: 0.3s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
      }

      .action-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
      }

      .admin-notice {
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid rgba(59, 130, 246, 0.4);
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        text-align: center;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }
        .question-text {
          font-size: 1.1rem;
        }
        .results-content {
          padding: 2rem;
        }
        .results-actions {
          flex-direction: column;
        }
        .date-container {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Questions Section -->
      <div class="experience-section active" id="questions">
        <form id="reflectionForm" class="questions-form">
          <div class="question-group">
            <div class="question-number">Question 1</div>
            <div class="question-text">What is your dream?</div>
            <div class="question-subtitle">
              (Choose just one â€” the one that calls you most right now.)
            </div>
            <textarea
              id="dreamInput"
              name="dream"
              class="question-textarea"
              placeholder="Write the dream that calls you"
              required
            ></textarea>
          </div>

          <div class="question-group">
            <div class="question-number">Question 2</div>
            <div class="question-text">
              What is your plan for achieving this dream?
            </div>
            <div class="question-subtitle">
              (Write what you already know. It's okay if it's unclear.)
            </div>
            <textarea
              id="planInput"
              name="plan"
              class="question-textarea"
              placeholder="Describe any plan (or absence of plan)"
              required
            ></textarea>
          </div>

          <div class="question-group">
            <div class="question-number">Question 3</div>
            <div class="question-text">
              Have you set a definite date for fulfilling your dream?
            </div>
            <div class="yes-no-buttons">
              <div class="yes-no-btn" id="yesBtn" data-value="yes">Yes</div>
              <div class="yes-no-btn" id="noBtn" data-value="no">No</div>
            </div>
            <input type="hidden" name="hasDate" required />
            <div
              class="date-container"
              id="dateContainer"
              style="display: none"
            >
              <label style="opacity: 0.8">What is the date?</label>
              <input type="date" class="question-input" name="dreamDate" />
            </div>
          </div>

          <div class="question-group">
            <div class="question-number">Question 4</div>
            <div class="question-text">
              What is your current relationship with this dream?
            </div>
            <div class="question-subtitle">
              (Do you believe you'll achieve it? Why or why not?)
            </div>
            <textarea
              id="relationshipInput"
              name="relationship"
              class="question-textarea"
              placeholder="How do you relate to this dream now?"
              required
            ></textarea>
          </div>

          <div class="question-group">
            <div class="question-number">Question 5</div>
            <div class="question-text">
              What are you willing to give in return?
            </div>
            <div class="question-subtitle">
              (Energy, focus, love, time â€” what will you offer to this dream?)
            </div>
            <textarea
              id="offeringInput"
              name="offering"
              class="question-textarea"
              placeholder="What will you offer in return?"
              required
            ></textarea>
          </div>

          <button type="submit" class="continue-btn" id="submitBtn">
            Receive Your Reflection
          </button>
        </form>
      </div>

      <!-- Loading Section -->
      <div class="experience-section hidden" id="loading">
        <div>
          <div class="loading-circle"></div>
          <div class="loading-text">Reflecting your truthâ€¦</div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="experience-section hidden" id="results">
        <div class="results">
          <div class="admin-notice" id="adminNotice" style="display: none">
            <span>âœ¨ Admin session â€” unlimited reflections</span>
          </div>
          <div class="results-content" id="reflectionContent"></div>
          <div class="results-actions">
            <button
              class="action-btn"
              id="emailBtn"
              onclick="emailReflection()"
            >
              <span>ðŸ“§</span><span>Email This Reflection</span>
            </button>
            <a href="/" class="action-btn">
              <span>ðŸªž</span><span>Reflect Again</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <script>
      let userData = null,
        hasDateSet = null,
        isAdminMode = false;

      function showSection(id) {
        document.querySelectorAll(".experience-section").forEach((sec) => {
          sec.classList.remove("active");
          setTimeout(() => sec.classList.add("hidden"), 300);
        });
        setTimeout(() => {
          document
            .querySelectorAll(".experience-section")
            .forEach((s) => s.classList.add("hidden"));
          const n = document.getElementById(id);
          n.classList.remove("hidden");
          setTimeout(() => n.classList.add("active"), 50);
        }, 300);
      }

      // Check for admin mode
      const url = new URLSearchParams(location.search);
      if (url.get("admin") === "true") {
        isAdminMode = true;
        document.getElementById("adminNotice").style.display = "block";
      }

      // Check for verified user (from PayPal payment)
      const stored = localStorage.getItem("mirrorVerifiedUser");
      if (stored) {
        try {
          userData = JSON.parse(stored);
        } catch (e) {
          console.error("Error parsing user data:", e);
          location.href = "./register.html";
        }
      } else if (!isAdminMode) {
        location.href = "./register.html";
      }

      // Start questions immediately
      setTimeout(animateQuestions, 300);
      setupInteractions();

      function animateQuestions() {
        document.querySelectorAll(".question-group").forEach((q, i) => {
          setTimeout(() => q.classList.add("visible"), i * 200);
        });
      }

      function setupInteractions() {
        document.querySelectorAll(".yes-no-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            this.parentNode
              .querySelectorAll(".yes-no-btn")
              .forEach((b) => b.classList.remove("selected"));
            this.classList.add("selected");
            hasDateSet = this.dataset.value;
            document.querySelector('input[name="hasDate"]').value = hasDateSet;
            if (hasDateSet === "yes") {
              document.getElementById("dateContainer").style.display = "flex";
              document
                .getElementById("dateContainer")
                .querySelector("input").required = true;
            } else {
              document.getElementById("dateContainer").style.display = "none";
              const inp = document
                .getElementById("dateContainer")
                .querySelector("input");
              inp.required = false;
              inp.value = "";
            }
          });
        });

        // Form submission
        document
          .getElementById("reflectionForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            showSection("loading");
            const f = new FormData(e.target);

            // Check if user is creator
            let creatorContext = null;
            let isCreatorMode = false;

            if (userData?.isCreator) {
              isCreatorMode = true;
              const storedContext = localStorage.getItem(
                "mirrorCreatorContext"
              );
              if (storedContext) {
                try {
                  creatorContext = JSON.parse(storedContext);
                } catch (e) {
                  console.warn("Failed to parse creator context:", e);
                }
              }
            }

            const payload = {
              dream: f.get("dream"),
              plan: f.get("plan"),
              hasDate: f.get("hasDate"),
              dreamDate: f.get("dreamDate"),
              relationship: f.get("relationship"),
              offering: f.get("offering"),
              userName: userData?.name || "Friend",
              userEmail: userData?.email || "",
              language: "en", // Always English
              isAdmin: isAdminMode,
              isCreator: isCreatorMode,
              creatorContext: creatorContext,
            };

            try {
              const r = await fetch("/api/mirror-reflection", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              const j = await r.json();
              if (!j.success) throw new Error(j.error || "Reflection failed");

              document.getElementById("reflectionContent").innerHTML =
                j.reflection;
              showSection("results");
            } catch (err) {
              console.error("Reflection error:", err);
              document.getElementById("reflectionContent").innerHTML = `
              <h2>A moment of silenceâ€¦</h2>
              <p>Your reflection is being prepared. Please try again in a moment.</p>
              <p style="opacity:.7;font-style:italic;">Sometimes the deepest truth needs space to emerge.</p>
            `;
              showSection("results");
            }
          });
      }

      function emailReflection() {
        if (!userData?.email) {
          const mail = prompt("Enter your email to receive this reflection:");
          if (!mail) return;
          userData = { ...userData, email: mail };
        }
        fetch("/api/send-mirror-email", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: userData.email,
            content: document.getElementById("reflectionContent").innerHTML,
            userName: userData.name || "Friend",
            language: "en",
          }),
        })
          .then((r) => r.json())
          .then((d) => {
            alert(
              d.success
                ? "Reflection sent to your email."
                : "There was an issue sending."
            );
          })
          .catch(() => alert("Error sending."));
      }
    </script>
  </body>
</html>
