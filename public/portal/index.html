<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <title>The Mirror of Truth</title>
    <link rel="stylesheet" href="/shared/foundation.css" />

    <style>
      /* Portal - Beautiful Mirror Experience */
      body {
        background: linear-gradient(
          135deg,
          #0f0f23 0%,
          #1a1a2e 25%,
          #16213e 50%,
          #0f0f23 100%
        );
        min-height: 100vh;
        overflow-x: hidden;
        color: #fff;
      }

      /* Mirror Shards - Sacred Geometry */
      .mirrors-container {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 1;
      }

      .mirror {
        position: absolute;
        width: clamp(30px, 6vw, 60px);
        height: clamp(30px, 6vw, 60px);
        background: rgba(255, 255, 255, 0.06);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        animation: float 12s ease-in-out infinite;
        transition: 0.4s ease;
      }

      .mirror:nth-child(1) {
        --rotation: 3deg;
        top: 15%;
        left: 18%;
        clip-path: polygon(20% 0%, 80% 10%, 100% 85%, 35% 100%, 0% 70%);
        animation-delay: 0s;
      }

      .mirror:nth-child(2) {
        --rotation: -6deg;
        top: 25%;
        right: 15%;
        clip-path: polygon(50% 0%, 90% 50%, 50% 100%, 10% 50%);
        animation-delay: 2s;
      }

      .mirror:nth-child(3) {
        --rotation: 8deg;
        top: 45%;
        left: 12%;
        clip-path: polygon(25% 0%, 100% 38%, 75% 100%, 0% 62%);
        animation-delay: 4s;
      }

      .mirror:nth-child(4) {
        --rotation: -4deg;
        top: 65%;
        right: 20%;
        width: clamp(40px, 8vw, 80px);
        height: clamp(40px, 8vw, 80px);
        clip-path: polygon(30% 0%, 85% 0%, 100% 70%, 45% 100%, 0% 65%);
        animation-delay: 6s;
      }

      .mirror:nth-child(5) {
        --rotation: 12deg;
        bottom: 25%;
        left: 35%;
        clip-path: polygon(15% 0%, 100% 25%, 85% 100%, 0% 75%);
        animation-delay: 8s;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0) rotate(0deg);
          opacity: 0.6;
        }
        25% {
          transform: translateY(-15px) rotate(2deg);
          opacity: 0.8;
        }
        50% {
          transform: translateY(-8px) rotate(-1deg);
          opacity: 1;
        }
        75% {
          transform: translateY(-12px) rotate(1deg);
          opacity: 0.7;
        }
      }

      /* Mirror shimmer effect */
      .mirror::after {
        content: "";
        position: absolute;
        inset: -10%;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.3) 0%,
          transparent 30%,
          rgba(255, 255, 255, 0.1) 100%
        );
        animation: shimmer 15s linear infinite;
        mix-blend-mode: overlay;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%) translateY(-100%);
        }
        100% {
          transform: translateX(100%) translateY(100%);
        }
      }

      /* Mirror hover effects */
      @media (hover: hover) {
        .mirrors-container.hover .mirror {
          animation-play-state: paused;
          background: rgba(255, 255, 255, 0.12);
          border-color: rgba(255, 255, 255, 0.3);
          box-shadow: 0 15px 45px rgba(255, 255, 255, 0.1);
          transform: scale(1.04) rotate(var(--rotation, 0deg));
        }

        .mirrors-container.hover .mirror::after {
          animation-play-state: paused;
          opacity: 0.6;
        }
      }

      /* Main Content */
      .main-content {
        position: relative;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 2rem 1rem;
      }

      .center-container {
        text-align: center;
        max-width: 600px;
        width: 100%;
      }

      .title {
        font-size: clamp(2.2rem, 7vw, 3.8rem);
        font-weight: 300;
        margin-bottom: 2rem;
        line-height: 1.2;
        opacity: 0.95;
        letter-spacing: -0.02em;
      }

      /* Navigation */
      .nav-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .about-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.8rem 1.5rem;
        background: linear-gradient(
          135deg,
          rgba(147, 51, 234, 0.12),
          rgba(99, 102, 241, 0.08)
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(147, 51, 234, 0.25);
        border-radius: 50px;
        color: rgba(255, 255, 255, 0.9);
        text-decoration: none;
        font-size: clamp(0.85rem, 2vw, 0.95rem);
        font-weight: 500;
        transition: all 0.3s ease;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        box-shadow: 0 8px 25px rgba(147, 51, 234, 0.15);
      }

      .about-link:hover {
        background: linear-gradient(
          135deg,
          rgba(147, 51, 234, 0.18),
          rgba(99, 102, 241, 0.12)
        );
        border-color: rgba(147, 51, 234, 0.4);
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(147, 51, 234, 0.2);
      }

      /* User Menu (for authenticated users) */
      .user-menu {
        position: relative;
        display: none;
      }

      .user-button {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.8rem 1.5rem;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 50px;
        color: rgba(255, 255, 255, 0.9);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }

      .user-button:hover {
        background: rgba(16, 185, 129, 0.15);
        border-color: rgba(16, 185, 129, 0.4);
        transform: translateY(-2px);
      }

      .user-dropdown {
        position: absolute;
        top: calc(100% + 0.5rem);
        right: 0;
        min-width: 240px;
        background: rgba(15, 15, 35, 0.95);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 16px;
        padding: 0.5rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        z-index: 200;
      }

      .user-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.8rem 1rem;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        border-radius: 12px;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
      }

      .dropdown-item:hover {
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.95);
      }

      /* Button Group */
      .button-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
        margin: 2rem 0;
      }

      .reflect-button {
        width: clamp(180px, 35vw, 240px);
        height: clamp(180px, 35vw, 240px);
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0.03) 70%
        );
        backdrop-filter: blur(30px);
        border: 2px solid rgba(255, 255, 255, 0.25);
        color: #fff;
        font-size: clamp(1rem, 3vw, 1.4rem);
        font-weight: 400;
        cursor: pointer;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        box-shadow: 0 15px 50px rgba(255, 255, 255, 0.08);
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }

      .reflect-button::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.06) 0%,
          transparent 70%
        );
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      .reflect-button::after {
        content: "";
        position: absolute;
        inset: 2px;
        border-radius: 50%;
        background: linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.02) 0%,
          transparent 50%,
          rgba(255, 255, 255, 0.02) 100%
        );
        opacity: 0;
        animation: magicalShimmer 3s ease-in-out infinite;
      }

      @keyframes magicalShimmer {
        0%,
        100% {
          opacity: 0;
          transform: rotate(0deg) scale(1);
        }
        50% {
          opacity: 0.3;
          transform: rotate(180deg) scale(1.02);
        }
      }

      .reflect-button:hover {
        transform: scale(1.03);
        border-color: rgba(255, 255, 255, 0.35);
        box-shadow: 0 20px 60px rgba(255, 255, 255, 0.12);
      }

      .reflect-button:hover::before {
        opacity: 1;
      }

      .reflect-button:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }

      .gift-button {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 1rem 2rem;
        background: linear-gradient(
          135deg,
          rgba(251, 146, 60, 0.08),
          rgba(251, 146, 60, 0.04)
        );
        backdrop-filter: blur(25px);
        border: 1px solid rgba(251, 146, 60, 0.2);
        border-radius: 20px;
        color: rgba(255, 255, 255, 0.9);
        font-size: clamp(0.9rem, 2.5vw, 1rem);
        font-weight: 400;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        box-shadow: 0 6px 20px rgba(251, 146, 60, 0.1);
      }

      .gift-button:hover {
        background: linear-gradient(
          135deg,
          rgba(251, 146, 60, 0.12),
          rgba(251, 146, 60, 0.06)
        );
        border-color: rgba(251, 146, 60, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(251, 146, 60, 0.15);
      }

      .gift-button:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }

      .start-free-button {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 1rem 2rem;
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.12),
          rgba(5, 150, 105, 0.08)
        );
        backdrop-filter: blur(25px);
        border: 1px solid rgba(16, 185, 129, 0.25);
        border-radius: 20px;
        color: rgba(255, 255, 255, 0.95);
        font-size: clamp(0.9rem, 2.5vw, 1rem);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.12);
      }

      .start-free-button:hover {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.18),
          rgba(5, 150, 105, 0.12)
        );
        border-color: rgba(16, 185, 129, 0.35);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.18);
      }

      .start-free-button:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }

      /* Taglines */
      .taglines {
        margin-top: 2rem;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
      }

      .tagline {
        font-size: clamp(0.9rem, 2.5vw, 1.1rem);
        opacity: 0.8;
        font-weight: 300;
        line-height: 1.6;
        margin-bottom: 1rem;
        letter-spacing: 0.3px;
      }

      .tagline strong {
        color: rgba(16, 185, 129, 0.9);
        font-weight: 500;
      }

      .sub-tagline {
        font-size: clamp(0.85rem, 2vw, 1rem);
        opacity: 0.6;
        font-weight: 300;
        line-height: 1.5;
      }

      .sub-tagline strong {
        color: rgba(16, 185, 129, 0.9);
        font-weight: 500;
      }

      /* Sign-in prompt */
      .sign-in-prompt {
        margin-top: 2rem;
        opacity: 0;
        animation: fadeIn 0.8s ease 1.5s forwards;
      }

      .sign-in-prompt.authenticated {
        display: none;
      }

      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }

      .prompt-text {
        font-size: clamp(0.85rem, 2vw, 0.95rem);
        color: rgba(255, 255, 255, 0.7);
        margin: 0;
      }

      .sign-in-link {
        color: #10b981;
        text-decoration: none;
        font-weight: 500;
        border-bottom: 1px solid rgba(16, 185, 129, 0.3);
        transition: all 0.3s ease;
      }

      .sign-in-link:hover {
        color: #6ee7b7;
        border-bottom-color: rgba(16, 185, 129, 0.6);
      }

      /* Usage status for authenticated users */
      .usage-status {
        margin-top: 2rem;
        padding: 1rem 1.5rem;
        background: rgba(255, 255, 255, 0.04);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        max-width: 320px;
        margin-left: auto;
        margin-right: auto;
        display: none;
      }

      .usage-status.show {
        display: block;
      }

      .usage-text {
        font-size: clamp(0.8rem, 2vw, 0.9rem);
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 0.8rem;
        text-align: center;
      }

      .usage-bar {
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
      }

      .usage-fill {
        height: 100%;
        background: linear-gradient(135deg, #10b981, #059669);
        border-radius: 2px;
        transition: width 0.8s ease;
        width: 0%;
      }

      .usage-fill.warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
      }

      .usage-fill.danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
      }

      /* Loading spinner */
      .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        border-top-color: rgba(255, 255, 255, 0.8);
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 0.5rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .nav-container {
          top: 1rem;
          right: 1rem;
        }

        .main-content {
          padding: 1rem 0.5rem;
          padding-top: 5rem; /* Extra space to avoid nav overlap */
        }

        .title {
          margin-bottom: 1.5rem;
        }

        .button-group {
          gap: 1.2rem;
          margin: 1.5rem 0;
        }

        .reflect-button {
          width: 160px;
          height: 160px;
          font-size: 1rem;
        }

        .gift-button {
          padding: 0.9rem 1.5rem;
          font-size: 0.85rem;
        }

        .user-dropdown {
          min-width: 200px;
          right: -0.5rem;
        }
      }

      @media (max-width: 480px) {
        .nav-container {
          top: 0.5rem;
          right: 0.5rem;
        }

        .main-content {
          padding: 0.5rem;
          padding-top: 6rem; /* More space on very small screens */
        }

        .about-link {
          padding: 0.7rem 1.2rem;
          font-size: 0.8rem;
        }

        .reflect-button {
          width: 140px;
          height: 140px;
          font-size: 0.9rem;
        }

        .gift-button,
        .start-free-button {
          padding: 0.8rem 1.2rem;
          font-size: 0.8rem;
        }

        .taglines {
          margin-top: 1.5rem;
        }
      }

      /* Accessibility */
      @media (prefers-reduced-motion: reduce) {
        .mirror,
        .reflect-button,
        .gift-button {
          animation: none;
          transition: none;
        }

        .mirror::after {
          animation: none;
        }
      }

      /* Focus styles for keyboard navigation */
      .reflect-button:focus,
      .gift-button:focus,
      .about-link:focus,
      .user-button:focus {
        outline: 2px solid rgba(16, 185, 129, 0.6);
        outline-offset: 2px;
      }
    </style>
  </head>

  <body>
    <!-- Mirror Shards -->
    <div class="mirrors-container" id="mirrorsContainer">
      <div class="mirror"></div>
      <div class="mirror"></div>
      <div class="mirror"></div>
      <div class="mirror"></div>
      <div class="mirror"></div>
    </div>

    <!-- Navigation -->
    <div class="nav-container">
      <a href="/about" class="about-link">
        <span>‚ú®</span>
        <span>Discover The Experience</span>
      </a>

      <!-- User Menu (shows when authenticated) -->
      <div class="user-menu" id="userMenu">
        <button class="user-button" id="userButton">
          <span class="user-avatar" id="userAvatar">üë§</span>
          <span class="user-name" id="userName">Loading...</span>
          <span class="dropdown-arrow">‚ñº</span>
        </button>

        <div class="user-dropdown" id="userDropdown">
          <a href="/dashboard" class="dropdown-item">
            <span>üè†</span>
            <span>Dashboard</span>
          </a>
          <a href="/reflections" class="dropdown-item">
            <span>üìö</span>
            <span>My Reflections</span>
          </a>
          <a
            href="/evolution"
            class="dropdown-item evolution-only"
            style="display: none"
          >
            <span>üå±</span>
            <span>Evolution Reports</span>
          </a>
          <a href="/settings" class="dropdown-item">
            <span>‚öôÔ∏è</span>
            <span>Settings</span>
          </a>
          <div
            style="
              height: 1px;
              background: rgba(255, 255, 255, 0.1);
              margin: 0.5rem 0;
            "
          ></div>
          <button class="dropdown-item" onclick="signOut()">
            <span>üö™</span>
            <span>Sign Out</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
      <section class="center-container">
        <h1 class="title">The Mirror of Truth</h1>

        <!-- Button Group -->
        <div class="button-group">
          <a href="/register" class="reflect-button" id="reflectButton">
            <span id="reflectButtonText">Reflect Me</span>
            <span
              class="loading-spinner"
              id="loadingSpinner"
              style="display: none"
            ></span>
          </a>

          <a href="/register?tier=free" class="start-free-button">
            <span>üå±</span>
            <span>Start Free Forever</span>
          </a>

          <a href="/gifting" class="gift-button">
            <span>üéÅ</span>
            <span>Gift a Reflection</span>
          </a>
        </div>

        <!-- Taglines -->
        <div class="taglines">
          <p class="tagline" id="mainTagline">
            Stop asking what to do.<br />
            See who you already are.
          </p>

          <p class="sub-tagline" id="subTagline">
            <strong>Start completely free.</strong> Your truth awaits.
          </p>
        </div>

        <!-- Usage Status (for authenticated users) -->
        <div class="usage-status" id="usageStatus">
          <div class="usage-text" id="usageText"></div>
          <div class="usage-bar">
            <div class="usage-fill" id="usageFill"></div>
          </div>
        </div>

        <!-- Sign In Prompt (for non-authenticated users) -->
        <div class="sign-in-prompt" id="signInPrompt">
          <p class="prompt-text">
            Already have an account?
            <a href="/auth/signin" class="sign-in-link">Sign in</a>
          </p>
        </div>
      </section>
    </main>

    <script>
      // Portal Logic - Consolidated
      let userState = null;

      // Initialize portal on load
      window.addEventListener("load", async () => {
        await detectUserState();
        updatePortalInterface();
        setupInteractions();
      });

      // Detect user authentication state
      async function detectUserState() {
        const token = localStorage.getItem("mirror_auth_token");

        if (!token) {
          userState = { authenticated: false };
          return;
        }

        try {
          const response = await fetch("/api/auth", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ action: "verify-token" }),
          });

          const result = await response.json();

          if (result.success && result.user) {
            // Get usage data
            const usageResponse = await fetch("/api/reflections", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ action: "check-usage" }),
            });

            const usageData = await usageResponse.json();

            userState = {
              authenticated: true,
              user: result.user,
              usage: usageData.success ? usageData.usage : null,
            };

            console.log("‚úÖ User authenticated:", userState.user.email);
          } else {
            localStorage.removeItem("mirror_auth_token");
            localStorage.removeItem("mirrorVerifiedUser");
            userState = { authenticated: false };
          }
        } catch (error) {
          console.error("Auth check failed:", error);
          userState = { authenticated: false };
        }
      }

      // Update portal interface based on user state
      function updatePortalInterface() {
        updateReflectButton();
        updateNavigation();
        updateTaglines();
        updateUsageDisplay();
        updateSignInVisibility();
      }

      function updateReflectButton() {
        const button = document.getElementById("reflectButton");
        const buttonText = document.getElementById("reflectButtonText");

        if (!userState.authenticated) {
          buttonText.textContent = "Reflect Me";
          button.href = "/register";
          return;
        }

        const user = userState.user;
        const usage = userState.usage;

        if (user.isCreator) {
          buttonText.textContent = "‚ú® Creator Space";
          button.href = "/reflection?mode=creator";
        } else if (usage && usage.canReflect) {
          buttonText.textContent = "Continue Journey";
          button.href = "/reflection";
        } else if (usage && !usage.canReflect) {
          buttonText.textContent = "Upgrade for More";
          button.href = "/register?upgrade=true";
        } else {
          buttonText.textContent = "View Reflections";
          button.href = "/dashboard";
        }
      }

      function updateNavigation() {
        const userMenu = document.getElementById("userMenu");
        const userName = document.getElementById("userName");
        const userAvatar = document.getElementById("userAvatar");

        if (!userState.authenticated) {
          userMenu.style.display = "none";
          return;
        }

        userMenu.style.display = "block";

        const user = userState.user;
        const firstName = user.name.split(" ")[0];
        userName.textContent = firstName;

        // Update avatar based on tier
        if (user.isCreator) {
          userAvatar.textContent = "üåü";
        } else if (user.tier === "premium") {
          userAvatar.textContent = "üíé";
        } else if (user.tier === "essential") {
          userAvatar.textContent = "‚ú®";
        } else {
          userAvatar.textContent = "üë§";
        }

        // Show/hide evolution link
        if (user.tier !== "free") {
          document.querySelector(".evolution-only").style.display = "flex";
        }
      }

      function updateTaglines() {
        const mainTagline = document.getElementById("mainTagline");
        const subTagline = document.getElementById("subTagline");

        if (!userState.authenticated) return;

        const user = userState.user;
        const usage = userState.usage;

        if (user.isCreator) {
          mainTagline.innerHTML = "Sacred creator space<br/>awaits your truth.";
          subTagline.textContent =
            "Unlimited reflections for the mirror maker.";
        } else if (usage && usage.canReflect) {
          mainTagline.innerHTML = "Ready for your next<br/>moment of truth?";
          subTagline.textContent = "Your reflection awaits.";
        } else if (usage && !usage.canReflect) {
          mainTagline.innerHTML = "Your journey continues<br/>beyond limits.";
          subTagline.textContent = "Upgrade to reflect again this month.";
        } else {
          mainTagline.innerHTML = "See how far<br/>you've traveled.";
          subTagline.textContent = "Your reflections hold your evolution.";
        }
      }

      function updateUsageDisplay() {
        const usageStatus = document.getElementById("usageStatus");
        const usageText = document.getElementById("usageText");
        const usageFill = document.getElementById("usageFill");

        if (!userState.authenticated || !userState.usage) {
          usageStatus.classList.remove("show");
          return;
        }

        const usage = userState.usage;
        const currentCount = usage.currentCount || 0;
        const limit = usage.limit;

        if (limit === "unlimited") {
          usageText.textContent = "Unlimited reflections this month";
          usageFill.style.width = "100%";
          usageFill.className = "usage-fill";
        } else {
          const percentage = Math.min((currentCount / limit) * 100, 100);
          usageText.textContent = `${currentCount} of ${limit} reflections used`;
          usageFill.style.width = `${percentage}%`;

          if (percentage >= 90) {
            usageFill.className = "usage-fill danger";
          } else if (percentage >= 70) {
            usageFill.className = "usage-fill warning";
          } else {
            usageFill.className = "usage-fill";
          }
        }

        usageStatus.classList.add("show");
      }

      function updateSignInVisibility() {
        const signInPrompt = document.getElementById("signInPrompt");

        if (userState.authenticated) {
          signInPrompt.classList.add("authenticated");
        } else {
          signInPrompt.classList.remove("authenticated");
        }
      }

      // User menu interactions
      function setupInteractions() {
        const userButton = document.getElementById("userButton");
        const userDropdown = document.getElementById("userDropdown");

        // User menu toggle
        if (userButton) {
          userButton.addEventListener("click", (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle("show");
          });
        }

        // Close dropdown when clicking outside
        document.addEventListener("click", (e) => {
          if (
            userDropdown &&
            !document.getElementById("userMenu").contains(e.target)
          ) {
            userDropdown.classList.remove("show");
          }
        });

        // Mirror hover effect (desktop only)
        if (window.matchMedia("(hover: hover)").matches) {
          const mirrorsContainer = document.getElementById("mirrorsContainer");
          const reflectButton = document.getElementById("reflectButton");

          reflectButton.addEventListener("mouseenter", () => {
            mirrorsContainer.classList.add("hover");
          });
          reflectButton.addEventListener("mouseleave", () => {
            mirrorsContainer.classList.remove("hover");
          });
        }
      }

      // Sign out function
      async function signOut() {
        try {
          const token = localStorage.getItem("mirror_auth_token");
          if (token) {
            await fetch("/api/auth", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ action: "signout" }),
            });
          }
        } catch (error) {
          console.error("Sign out error:", error);
        }

        localStorage.removeItem("mirror_auth_token");
        localStorage.removeItem("mirrorVerifiedUser");
        window.location.reload();
      }

      // Debug
      if (window.location.hostname === "localhost") {
        console.log("ü™û Sacred Portal initialized");
        window.portalDebug = {
          userState: () => userState,
          refreshState: detectUserState,
        };
      }
    </script>
  </body>
</html>
