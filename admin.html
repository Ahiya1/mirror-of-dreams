<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel | ◊§◊ê◊†◊ú ◊†◊ô◊î◊ï◊ú</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(
          135deg,
          #0f0f23 0%,
          #1a1a2e 25%,
          #16213e 50%,
          #0f0f23 100%
        );
        min-height: 100vh;
        color: white;
        padding: 2rem;
      }

      [dir="rtl"] {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 3rem;
        position: relative;
      }

      .language-toggle {
        position: absolute;
        top: 0;
        right: 0;
      }

      [dir="rtl"] .language-toggle {
        right: auto;
        left: 0;
      }

      .lang-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
      }

      .lang-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      .header p {
        opacity: 0.7;
        font-size: 1rem;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
      }

      .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: #f59e0b;
      }

      .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .admin-sections {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
      }

      .admin-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 2rem;
      }

      .admin-card h3 {
        margin-bottom: 1.5rem;
        font-size: 1.3rem;
        font-weight: 600;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        opacity: 0.9;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.8rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        color: white;
        font-size: 0.9rem;
      }

      .form-group input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .btn {
        padding: 0.8rem 1.5rem;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        width: 100%;
        margin-top: 0.5rem;
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .btn-primary {
        background: rgba(59, 130, 246, 0.3);
        border-color: rgba(59, 130, 246, 0.5);
      }

      .btn-success {
        background: rgba(34, 197, 94, 0.3);
        border-color: rgba(34, 197, 94, 0.5);
      }

      .btn-danger {
        background: rgba(239, 68, 68, 0.3);
        border-color: rgba(239, 68, 68, 0.5);
      }

      .quick-actions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .sessions-section {
        grid-column: 1 / -1;
      }

      .sessions-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .session-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .session-info {
        flex: 1;
        min-width: 200px;
      }

      .session-email {
        font-weight: 500;
        margin-bottom: 0.2rem;
      }

      .session-meta {
        font-size: 0.8rem;
        opacity: 0.7;
      }

      .session-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .btn-small {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        width: auto;
        margin: 0;
      }

      .status {
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
      }

      .status-pending {
        background: rgba(251, 191, 36, 0.3);
        color: #fbbf24;
      }

      .status-completed {
        background: rgba(34, 197, 94, 0.3);
        color: #22c55e;
      }

      .notification {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: rgba(34, 197, 94, 0.9);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1000;
      }

      [dir="rtl"] .notification {
        right: auto;
        left: 2rem;
        transform: translateX(-100%);
      }

      [dir="rtl"] .notification.show {
        transform: translateX(0);
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.error {
        background: rgba(239, 68, 68, 0.9);
      }

      .admin-access {
        background: rgba(99, 102, 241, 0.2);
        border: 1px solid rgba(99, 102, 241, 0.4);
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        text-align: center;
      }

      .admin-link {
        display: inline-block;
        padding: 0.8rem 1.5rem;
        background: rgba(99, 102, 241, 0.3);
        border: 1px solid rgba(99, 102, 241, 0.5);
        border-radius: 8px;
        color: white;
        text-decoration: none;
        transition: all 0.3s ease;
        margin-top: 1rem;
      }

      .admin-link:hover {
        background: rgba(99, 102, 241, 0.5);
        transform: translateY(-2px);
      }

      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }

        .admin-sections {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .session-item {
          flex-direction: column;
          align-items: flex-start;
        }

        .session-actions {
          width: 100%;
          justify-content: flex-start;
        }

        .header {
          text-align: center;
        }

        .language-toggle {
          position: static;
          margin-bottom: 1rem;
          display: flex;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="language-toggle">
          <button id="langToggle" class="lang-btn">
            <span class="lang-flag">üáÆüá±</span>
            <span class="lang-text">◊¢◊ë◊®◊ô◊™</span>
          </button>
        </div>
        <h1 id="mainTitle">The Mirror of Truth</h1>
        <p id="subtitle">Admin Panel - Booth Management</p>
      </div>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="todayReflections">0</div>
          <div class="stat-label" id="todayReflectionsLabel">
            Today's Reflections
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="todayRevenue">0</div>
          <div class="stat-label" id="todayRevenueLabel">
            Today's Revenue (‚Ç™)
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendingCash">0</div>
          <div class="stat-label" id="pendingCashLabel">Pending Cash</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalReflections">0</div>
          <div class="stat-label" id="totalReflectionsLabel">
            Total Reflections
          </div>
        </div>
      </div>

      <!-- Admin Access for Testing -->
      <div class="admin-access">
        <div id="adminAccessText">
          üöÄ Test the system as admin (unlimited reflections)
        </div>
        <a href="/reflection.html?admin=true" class="admin-link" id="adminLink">
          <span id="adminLinkText">Start Admin Reflection</span>
        </a>
      </div>

      <!-- Admin Actions -->
      <div class="admin-sections">
        <!-- Send Access Code -->
        <div class="admin-card">
          <h3 id="cashPaymentTitle">üí∞ Cash Payment Access</h3>
          <form id="sendCodeForm">
            <div class="form-group">
              <label for="userEmail" id="emailLabel">Customer Email</label>
              <input type="email" id="userEmail" required />
            </div>
            <div class="form-group">
              <label for="userName" id="nameLabel">Customer Name</label>
              <input type="text" id="userName" required />
            </div>
            <button type="submit" class="btn btn-success" id="sendCodeBtn">
              Send Access Code
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="sendReceiptBtn"
              onclick="sendCashReceipt()"
            >
              Send Receipt
            </button>
          </form>
        </div>

        <!-- Location Settings -->
        <div class="admin-card">
          <h3 id="locationTitle">üìç Booth Location</h3>
          <div class="form-group">
            <label for="currentLocation" id="locationLabel"
              >Current Location</label
            >
            <select id="currentLocation">
              <option value="rothschild">Rothschild Boulevard</option>
              <option value="online">Online Only</option>
              <option value="dizengoff">Dizengoff Center</option>
              <option value="sarona">Sarona Market</option>
              <option value="custom">Custom Location</option>
            </select>
          </div>
          <div
            class="form-group"
            id="customLocationGroup"
            style="display: none"
          >
            <label for="customLocationText" id="customLocationLabel"
              >Custom Location</label
            >
            <input type="text" id="customLocationText" />
          </div>
          <button
            class="btn btn-primary"
            onclick="updateLocation()"
            id="updateLocationBtn"
          >
            Update Location
          </button>
        </div>

        <!-- Quick Actions -->
        <div class="admin-card">
          <h3 id="quickActionsTitle">‚ö° Quick Actions</h3>
          <div class="quick-actions">
            <button
              class="btn btn-primary"
              onclick="generateDailyReport()"
              id="dailyReportBtn"
            >
              üìä Generate Daily Report
            </button>
            <button
              class="btn btn-primary"
              onclick="exportData()"
              id="exportDataBtn"
            >
              üíæ Export All Data
            </button>
            <button
              class="btn btn-danger"
              onclick="clearPendingCash()"
              id="clearPendingBtn"
            >
              üóëÔ∏è Clear Pending Cash
            </button>
          </div>
        </div>

        <!-- Booth Status -->
        <div class="admin-card">
          <h3 id="boothStatusTitle">üè™ Booth Status</h3>
          <div class="form-group">
            <label for="boothStatus" id="statusLabel">Status</label>
            <select id="boothStatus">
              <option value="open">üü¢ Open</option>
              <option value="break">üü° On Break</option>
              <option value="closed">üî¥ Closed</option>
            </select>
          </div>
          <button
            class="btn btn-primary"
            onclick="updateBoothStatus()"
            id="updateStatusBtn"
          >
            Update Status
          </button>
          <div
            id="statusDisplay"
            style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8"
          >
            <span id="statusDisplayText">Current: Open</span>
          </div>
        </div>

        <!-- Recent Sessions -->
        <div class="admin-card sessions-section">
          <h3 id="recentSessionsTitle">üìù Recent Sessions</h3>
          <div class="sessions-list" id="sessionsList">
            <!-- Sessions will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
      // Language management
      let currentLanguage = localStorage.getItem("adminLanguage") || "en";

      const translations = {
        en: {
          mainTitle: "The Mirror of Truth",
          subtitle: "Admin Panel - Booth Management",
          todayReflectionsLabel: "Today's Reflections",
          todayRevenueLabel: "Today's Revenue (‚Ç™)",
          pendingCashLabel: "Pending Cash",
          totalReflectionsLabel: "Total Reflections",
          adminAccessText:
            "üöÄ Test the system as admin (unlimited reflections)",
          adminLinkText: "Start Admin Reflection",
          cashPaymentTitle: "üí∞ Cash Payment Access",
          emailLabel: "Customer Email",
          nameLabel: "Customer Name",
          sendCodeBtn: "Send Access Code",
          sendReceiptBtn: "Send Receipt",
          locationTitle: "üìç Booth Location",
          locationLabel: "Current Location",
          customLocationLabel: "Custom Location",
          updateLocationBtn: "Update Location",
          quickActionsTitle: "‚ö° Quick Actions",
          dailyReportBtn: "üìä Generate Daily Report",
          exportDataBtn: "üíæ Export All Data",
          clearPendingBtn: "üóëÔ∏è Clear Pending Cash",
          boothStatusTitle: "üè™ Booth Status",
          statusLabel: "Status",
          updateStatusBtn: "Update Status",
          statusDisplayText: "Current: Open",
          recentSessionsTitle: "üìù Recent Sessions",
          langText: "◊¢◊ë◊®◊ô◊™",
          emailPlaceholder: "customer@email.com",
          namePlaceholder: "Customer Name",
          customLocationPlaceholder: "Enter custom location",
          noSessions: "No sessions yet today",
          markComplete: "Mark Complete",
          viewBtn: "View",
          accessCodeSent: "Access code sent successfully!",
          receiptSent: "Receipt sent successfully!",
          locationUpdated: "Location updated successfully!",
          statusUpdated: "Booth status updated!",
          dailyReportGenerated: "Daily report generated (check console)",
          dataExported: "Data exported successfully",
          pendingCleared: "Pending cash payments cleared",
          errorSending: "Error sending. Please try again.",
          confirmClear:
            "Are you sure you want to clear all pending cash payments?",
          sessionCompleted: "Session marked as completed",
        },
        he: {
          mainTitle: "◊û◊®◊ê◊î ◊î◊ê◊û◊™",
          subtitle: "◊§◊ê◊†◊ú ◊†◊ô◊î◊ï◊ú - ◊†◊ô◊î◊ï◊ú ◊ì◊ï◊õ◊ü",
          todayReflectionsLabel: "◊î◊©◊™◊ß◊§◊ï◊ô◊ï◊™ ◊î◊ô◊ï◊ù",
          todayRevenueLabel: "◊î◊õ◊†◊°◊ï◊™ ◊î◊ô◊ï◊ù (‚Ç™)",
          pendingCashLabel: "◊û◊ñ◊ï◊û◊ü ◊û◊û◊™◊ô◊ü",
          totalReflectionsLabel: "◊°◊î◊¥◊õ ◊î◊©◊™◊ß◊§◊ï◊ô◊ï◊™",
          adminAccessText: "üöÄ ◊ë◊ì◊ï◊ß ◊ê◊™ ◊î◊û◊¢◊®◊õ◊™ ◊õ◊û◊†◊î◊ú (◊î◊©◊™◊ß◊§◊ï◊ô◊ï◊™ ◊ú◊ú◊ê ◊î◊í◊ë◊ú◊î)",
          adminLinkText: "◊î◊™◊ó◊ú ◊î◊©◊™◊ß◊§◊ï◊™ ◊û◊†◊î◊ú",
          cashPaymentTitle: "üí∞ ◊í◊ô◊©◊î ◊ú◊™◊©◊ú◊ï◊ù ◊û◊ñ◊ï◊û◊ü",
          emailLabel: "◊û◊ô◊ô◊ú ◊ú◊ß◊ï◊ó",
          nameLabel: "◊©◊ù ◊ú◊ß◊ï◊ó",
          sendCodeBtn: "◊©◊ú◊ó ◊ß◊ï◊ì ◊í◊ô◊©◊î",
          sendReceiptBtn: "◊©◊ú◊ó ◊ß◊ë◊ú◊î",
          locationTitle: "üìç ◊û◊ô◊ß◊ï◊ù ◊ì◊ï◊õ◊ü",
          locationLabel: "◊û◊ô◊ß◊ï◊ù ◊†◊ï◊õ◊ó◊ô",
          customLocationLabel: "◊û◊ô◊ß◊ï◊ù ◊û◊ï◊™◊ê◊ù",
          updateLocationBtn: "◊¢◊ì◊õ◊ü ◊û◊ô◊ß◊ï◊ù",
          quickActionsTitle: "‚ö° ◊§◊¢◊ï◊ú◊ï◊™ ◊û◊î◊ô◊®◊ï◊™",
          dailyReportBtn: "üìä ◊¶◊ï◊® ◊ì◊ï◊ó ◊ô◊ï◊û◊ô",
          exportDataBtn: "üíæ ◊ô◊ô◊¶◊ê ◊õ◊ú ◊î◊†◊™◊ï◊†◊ô◊ù",
          clearPendingBtn: "üóëÔ∏è ◊†◊ß◊î ◊û◊ñ◊ï◊û◊ü ◊û◊û◊™◊ô◊ü",
          boothStatusTitle: "üè™ ◊°◊ò◊ò◊ï◊° ◊ì◊ï◊õ◊ü",
          statusLabel: "◊°◊ò◊ò◊ï◊°",
          updateStatusBtn: "◊¢◊ì◊õ◊ü ◊°◊ò◊ò◊ï◊°",
          statusDisplayText: "◊†◊ï◊õ◊ó◊ô: ◊§◊™◊ï◊ó",
          recentSessionsTitle: "üìù ◊°◊©◊†◊ô◊ù ◊ê◊ó◊®◊ï◊†◊ô◊ù",
          langText: "English",
          emailPlaceholder: "customer@email.com",
          namePlaceholder: "◊©◊ù ◊ú◊ß◊ï◊ó",
          customLocationPlaceholder: "◊î◊õ◊†◊° ◊û◊ô◊ß◊ï◊ù ◊û◊ï◊™◊ê◊ù",
          noSessions: "◊ê◊ô◊ü ◊°◊©◊†◊ô◊ù ◊î◊ô◊ï◊ù ◊¢◊ì◊ô◊ô◊ü",
          markComplete: "◊°◊û◊ü ◊õ◊î◊ï◊©◊ú◊ù",
          viewBtn: "◊¶◊§◊î",
          accessCodeSent: "◊ß◊ï◊ì ◊í◊ô◊©◊î ◊†◊©◊ú◊ó ◊ë◊î◊¶◊ú◊ó◊î!",
          receiptSent: "◊ß◊ë◊ú◊î ◊†◊©◊ú◊ó◊î ◊ë◊î◊¶◊ú◊ó◊î!",
          locationUpdated: "◊û◊ô◊ß◊ï◊ù ◊¢◊ï◊ì◊õ◊ü ◊ë◊î◊¶◊ú◊ó◊î!",
          statusUpdated: "◊°◊ò◊ò◊ï◊° ◊ì◊ï◊õ◊ü ◊¢◊ï◊ì◊õ◊ü!",
          dailyReportGenerated: "◊ì◊ï◊ó ◊ô◊ï◊û◊ô ◊†◊ï◊¶◊® (◊ë◊ì◊ï◊ß ◊ë◊ß◊ï◊†◊°◊ï◊ú)",
          dataExported: "◊†◊™◊ï◊†◊ô◊ù ◊ô◊ï◊¶◊ê◊ï ◊ë◊î◊¶◊ú◊ó◊î",
          pendingCleared: "◊™◊©◊ú◊ï◊û◊ô ◊û◊ñ◊ï◊û◊ü ◊û◊û◊™◊ô◊†◊ô◊ù ◊†◊ï◊ß◊ï",
          errorSending: "◊©◊í◊ô◊ê◊î ◊ë◊©◊ú◊ô◊ó◊î. ◊ê◊†◊ê ◊†◊°◊î ◊©◊ï◊ë.",
          confirmClear:
            "◊î◊ê◊ù ◊ê◊™◊î ◊ë◊ò◊ï◊ó ◊©◊ë◊®◊¶◊ï◊†◊ö ◊ú◊†◊ß◊ï◊™ ◊ê◊™ ◊õ◊ú ◊™◊©◊ú◊ï◊û◊ô ◊î◊û◊ñ◊ï◊û◊ü ◊î◊û◊û◊™◊ô◊†◊ô◊ù?",
          sessionCompleted: "◊°◊©◊ü ◊°◊ï◊û◊ü ◊õ◊î◊ï◊©◊ú◊ù",
        },
      };

      // Mock data - in real implementation, this would come from API
      let sessions = [
        {
          id: 1,
          email: "sarah@email.com",
          name: "Sarah",
          status: "completed",
          payment: "cash",
          timestamp: new Date().toISOString(),
          dream: "Start an art studio",
          language: "en",
        },
        {
          id: 2,
          email: "david@email.com",
          name: "David",
          status: "pending",
          payment: "cash",
          timestamp: new Date(Date.now() - 1000 * 60 * 30).toISOString(),
          dream: "Launch tech startup",
          language: "en",
        },
      ];

      // Initialize admin panel
      document.addEventListener("DOMContentLoaded", function () {
        applyLanguage();
        updateStats();
        renderSessions();
        setupEventListeners();
      });

      function applyLanguage() {
        const t = translations[currentLanguage];
        const html = document.documentElement;

        // Set direction and language
        html.setAttribute("dir", currentLanguage === "he" ? "rtl" : "ltr");
        html.setAttribute("lang", currentLanguage);

        // Update all text content
        Object.keys(t).forEach((key) => {
          const element = document.getElementById(key);
          if (element) {
            element.textContent = t[key];
          }
        });

        // Update language toggle
        document.querySelector(".lang-text").textContent = t.langText;
        document.querySelector(".lang-flag").textContent =
          currentLanguage === "en" ? "üáÆüá±" : "üá∫üá∏";

        // Update placeholders
        document.getElementById("userEmail").placeholder = t.emailPlaceholder;
        document.getElementById("userName").placeholder = t.namePlaceholder;
        document.getElementById("customLocationText").placeholder =
          t.customLocationPlaceholder;

        // Update admin link
        const adminLink = document.getElementById("adminLink");
        adminLink.href = `/reflection.html?admin=true&lang=${currentLanguage}`;
      }

      function setupEventListeners() {
        // Language toggle
        document
          .getElementById("langToggle")
          .addEventListener("click", toggleLanguage);

        // Send code form
        document
          .getElementById("sendCodeForm")
          .addEventListener("submit", handleSendCode);

        // Location change
        document
          .getElementById("currentLocation")
          .addEventListener("change", function () {
            const customGroup = document.getElementById("customLocationGroup");
            if (this.value === "custom") {
              customGroup.style.display = "block";
            } else {
              customGroup.style.display = "none";
            }
          });
      }

      function toggleLanguage() {
        currentLanguage = currentLanguage === "en" ? "he" : "en";
        localStorage.setItem("adminLanguage", currentLanguage);
        applyLanguage();
      }

      async function handleSendCode(e) {
        e.preventDefault();

        const email = document.getElementById("userEmail").value;
        const name = document.getElementById("userName").value;

        try {
          const response = await fetch("/api/send-access-code", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, name }),
          });

          const result = await response.json();

          if (result.success) {
            showNotification(translations[currentLanguage].accessCodeSent);
            document.getElementById("sendCodeForm").reset();

            // Add to sessions list
            const newSession = {
              id: Date.now(),
              email,
              name,
              status: "pending",
              payment: "cash",
              timestamp: new Date().toISOString(),
              accessCode: result.accessCode,
              language: currentLanguage,
            };
            sessions.unshift(newSession);
            renderSessions();
            updateStats();
          } else {
            throw new Error(result.error || "Failed to send code");
          }
        } catch (error) {
          console.error("Error sending code:", error);
          showNotification(translations[currentLanguage].errorSending, "error");
        }
      }

      async function sendCashReceipt() {
        const email = document.getElementById("userEmail").value;
        const name = document.getElementById("userName").value;

        if (!email || !name) {
          alert(
            currentLanguage === "he"
              ? "◊ê◊†◊ê ◊û◊ú◊ê ◊©◊ù ◊ï◊û◊ô◊ô◊ú ◊ú◊ß◊ï◊ó"
              : "Please fill customer name and email"
          );
          return;
        }

        try {
          const response = await fetch("/api/generate-receipt", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email,
              name,
              amount: 20,
              paymentMethod: "cash",
              language: currentLanguage,
            }),
          });

          const result = await response.json();

          if (result.success) {
            showNotification(translations[currentLanguage].receiptSent);
          } else {
            throw new Error(result.error || "Failed to send receipt");
          }
        } catch (error) {
          console.error("Error sending receipt:", error);
          showNotification(translations[currentLanguage].errorSending, "error");
        }
      }

      function updateStats() {
        const today = new Date().toDateString();
        const todaySessions = sessions.filter(
          (s) => new Date(s.timestamp).toDateString() === today
        );

        document.getElementById("todayReflections").textContent =
          todaySessions.length;
        document.getElementById("todayRevenue").textContent =
          todaySessions.length * 20;
        document.getElementById("pendingCash").textContent = sessions.filter(
          (s) => s.status === "pending" && s.payment === "cash"
        ).length;
        document.getElementById("totalReflections").textContent =
          sessions.length;
      }

      function renderSessions() {
        const container = document.getElementById("sessionsList");
        const t = translations[currentLanguage];

        if (sessions.length === 0) {
          container.innerHTML = `<p style="text-align: center; opacity: 0.6;">${t.noSessions}</p>`;
          return;
        }

        container.innerHTML = sessions
          .map(
            (session) => `
                <div class="session-item">
                    <div class="session-info">
                        <div class="session-email">${session.email}</div>
                        <div class="session-meta">
                            ${session.name} ‚Ä¢ ${session.payment} ‚Ä¢ ${formatTime(
              session.timestamp
            )}
                            ${
                              session.dream
                                ? ` ‚Ä¢ ${session.dream.substring(0, 30)}...`
                                : ""
                            }
                        </div>
                    </div>
                    <div class="session-actions">
                        <span class="status status-${session.status}">${
              session.status
            }</span>
                        ${
                          session.status === "pending"
                            ? `<button class="btn btn-small" onclick="markCompleted(${session.id})">${t.markComplete}</button>`
                            : ""
                        }
                        <button class="btn btn-small" onclick="viewSession(${
                          session.id
                        })">${t.viewBtn}</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function formatTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString(
          currentLanguage === "he" ? "he-IL" : "en-US",
          {
            hour: "2-digit",
            minute: "2-digit",
          }
        );
      }

      function markCompleted(sessionId) {
        const session = sessions.find((s) => s.id === sessionId);
        if (session) {
          session.status = "completed";
          renderSessions();
          updateStats();
          showNotification(translations[currentLanguage].sessionCompleted);
        }
      }

      function viewSession(sessionId) {
        const session = sessions.find((s) => s.id === sessionId);
        if (session) {
          const details =
            currentLanguage === "he"
              ? `◊§◊®◊ò◊ô ◊°◊©◊ü:\n\n◊©◊ù: ${session.name}\n◊û◊ô◊ô◊ú: ${
                  session.email
                }\n◊°◊ò◊ò◊ï◊°: ${session.status}\n◊™◊©◊ú◊ï◊ù: ${
                  session.payment
                }\n◊ñ◊û◊ü: ${new Date(session.timestamp).toLocaleString(
                  "he-IL"
                )}\n${session.dream ? `◊ó◊ú◊ï◊ù: ${session.dream}` : ""}`
              : `Session Details:\n\nName: ${session.name}\nEmail: ${
                  session.email
                }\nStatus: ${session.status}\nPayment: ${
                  session.payment
                }\nTime: ${new Date(session.timestamp).toLocaleString()}\n${
                  session.dream ? `Dream: ${session.dream}` : ""
                }`;
          alert(details);
        }
      }

      function updateLocation() {
        const location = document.getElementById("currentLocation").value;
        const customLocation =
          document.getElementById("customLocationText").value;

        const finalLocation = location === "custom" ? customLocation : location;
        showNotification(translations[currentLanguage].locationUpdated);
      }

      function updateBoothStatus() {
        const status = document.getElementById("boothStatus").value;
        const statusMap = {
          open: currentLanguage === "he" ? "üü¢ ◊§◊™◊ï◊ó" : "üü¢ Open",
          break: currentLanguage === "he" ? "üü° ◊î◊§◊°◊ß◊î" : "üü° On Break",
          closed: currentLanguage === "he" ? "üî¥ ◊°◊í◊ï◊®" : "üî¥ Closed",
        };

        document.getElementById("statusDisplayText").textContent = `${
          currentLanguage === "he" ? "◊†◊ï◊õ◊ó◊ô" : "Current"
        }: ${statusMap[status]}`;
        showNotification(translations[currentLanguage].statusUpdated);
      }

      function generateDailyReport() {
        const today = new Date().toDateString();
        const todaySessions = sessions.filter(
          (s) => new Date(s.timestamp).toDateString() === today
        );

        const report = `Daily Report - ${today}
            
Sessions: ${todaySessions.length}
Revenue: ‚Ç™${todaySessions.length * 20}
Cash Payments: ${todaySessions.filter((s) => s.payment === "cash").length}
Bit Payments: ${todaySessions.filter((s) => s.payment === "bit").length}
Completion Rate: ${Math.round(
          (todaySessions.filter((s) => s.status === "completed").length /
            todaySessions.length) *
            100
        )}%`;

        console.log(report);
        showNotification(translations[currentLanguage].dailyReportGenerated);
      }

      function exportData() {
        const data = JSON.stringify(sessions, null, 2);
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `mirror-sessions-${
          new Date().toISOString().split("T")[0]
        }.json`;
        a.click();
        URL.revokeObjectURL(url);
        showNotification(translations[currentLanguage].dataExported);
      }

      function clearPendingCash() {
        if (confirm(translations[currentLanguage].confirmClear)) {
          sessions = sessions.filter(
            (s) => !(s.status === "pending" && s.payment === "cash")
          );
          renderSessions();
          updateStats();
          showNotification(translations[currentLanguage].pendingCleared);
        }
      }

      function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add("show");

        setTimeout(() => {
          notification.classList.remove("show");
        }, 3000);
      }

      // Simulate real-time updates
      setInterval(() => {
        updateStats();
      }, 30000);
    </script>
  </body>
</html>
